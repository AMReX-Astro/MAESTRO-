

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MAESTROeX Flowchart &mdash; MAESTROeX 18.12
 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Getting Started" href="getting_started.html" />
    <link rel="prev" title="Introduction to MAESTROeX" href="introduction.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> MAESTROeX
          

          
          </a>

          
            
            
              <div class="version">
                18.12

              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">MAESTROeX basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to MAESTROeX</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MAESTROeX Flowchart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#summary-of-the-maestroex-equation-set">Summary of the MAESTROeX&nbsp;Equation Set</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#base-state">Base State</a></li>
<li class="toctree-l3"><a class="reference internal" href="#continuity">Continuity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constraint">Constraint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#momentum">Momentum</a></li>
<li class="toctree-l3"><a class="reference internal" href="#base-state-expansion">Base State Expansion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#energy">Energy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#time-advancement-algorithm">Time Advancement Algorithm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#definitions">Definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sec-flow-singlestep-single-step">[sec:flow:singlestep] Single Step</a></li>
<li class="toctree-l3"><a class="reference internal" href="#volume-discrepancy-changes">Volume Discrepancy Changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sec-flow-gamma1vary-gamma-1-variation-changes">[sec:flow:gamma1vary] <span class="math notranslate nohighlight">\(\Gamma_1\)</span> Variation Changes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#keeping-to-first-order-in-delta-gamma-1">Keeping to First Order in <span class="math notranslate nohighlight">\(\delta\Gamma_1\)</span></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#thermal-diffusion-changes">Thermal Diffusion Changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#initialization">Initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changes-from-earlier-implementations">Changes from Earlier Implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#changes-between-paper-3-and-paper-4">Changes Between Paper 3 and Paper 4</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changes-between-paper-4-and-the-multilevel-paper">Changes Between Paper 4 and the Multilevel Paper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changes-between-the-multilevel-paper-and-paper-5-raw-latex-cite-wdconvect">Changes Between the Multilevel Paper and Paper 5&nbsp;:raw-latex:`\cite{wdconvect}`</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changes-between-paper-5-and-the-xrb-paper">Changes Between Paper 5 and the XRB Paper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changes-since-the-xrb-paper">Changes Since the XRB Paper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#future-considerations">Future Considerations</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Using MAESTROeX</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="problems.html">Problem Setups</a></li>
<li class="toctree-l1"><a class="reference internal" href="unit_tests.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="common_parameters.html">Common Runtime Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">MAESTROeX Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="param_intro.html">Runtime Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="initial_models.html">Initial Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="analysis.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="makefiles.html">MAESTROeX Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="managingjobs.html">Managing Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption"><span class="caption-text">MAESTROeX technical details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="lo_density.html">Low Density Cutoffs</a></li>
<li class="toctree-l1"><a class="reference internal" href="volume_discrepancy.html">Volume Discrepancy Factor</a></li>
<li class="toctree-l1"><a class="reference internal" href="eos_notes.html">Equation of State Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="networks.html">Reaction Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="eta.html">The Mixing Term, <span class="math notranslate nohighlight">\(\etarho\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="eta.html#eta-flow-chart"><span class="math notranslate nohighlight">\(\eta\)</span> Flow Chart</a></li>
<li class="toctree-l1"><a class="reference internal" href="eta.html#computing-etarhoec-and-etarhocc">Computing <span class="math notranslate nohighlight">\(\etarhoec\)</span> and <span class="math notranslate nohighlight">\(\etarhocc\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="eta.html#using-etarhoec">Using <span class="math notranslate nohighlight">\(\etarhoec\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="eta.html#using-etarhocc">Using <span class="math notranslate nohighlight">\(\etarhocc\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="pert.html">Interface State Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="sdc.html">Spectral Deferred Corrections</a></li>
<li class="toctree-l1"><a class="reference internal" href="Godunov.html">Godunov Interface States</a></li>
<li class="toctree-l1"><a class="reference internal" href="mg.html">Multigrid</a></li>
<li class="toctree-l1"><a class="reference internal" href="rotation.html">Rotation in MAESTROeX</a></li>
<li class="toctree-l1"><a class="reference internal" href="spherical_basestate.html">Modifications for a Spherical Self-Gravitating Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="planar_invsq_basestate.html">Modifications for a <span class="math notranslate nohighlight">\(1/r^2\)</span> Plane-Parallel Basestate</a></li>
<li class="toctree-l1"><a class="reference internal" href="thermo_notes.html">Notes on Thermodynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="beta0.html">Notes on <span class="math notranslate nohighlight">\(\beta_0\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="enthalpy.html">Notes on Enthalpy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MAESTROeX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>MAESTROeX Flowchart</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/flowchart.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="maestroex-flowchart">
<h1>MAESTROeX Flowchart<a class="headerlink" href="#maestroex-flowchart" title="Permalink to this headline">¶</a></h1>
<p>The equation set and solution procedure used by MAESTROeX&nbsp;has evolved
over time. In this chapter, we outline the algorithm currently
implemented in the code. The latest published reference for MAESTROeX
is the multilevel paper <a href="#id1"><span class="problematic" id="id2">:raw-latex:`\cite{multilevel}`</span></a>. In this description, we
make frequent reference to paper&nbsp;I <a href="#id3"><span class="problematic" id="id4">:raw-latex:`\cite{lowMach}`</span></a>,
paper&nbsp;II <a href="#id5"><span class="problematic" id="id6">:raw-latex:`\cite{lowMach2}`</span></a>, paper&nbsp;III <a href="#id7"><span class="problematic" id="id8">:raw-latex:`\cite{lowMach3}`</span></a>, and
paper&nbsp;IV <a href="#id9"><span class="problematic" id="id10">:raw-latex:`\cite{lowMach4}`</span></a>.</p>
<div class="section" id="summary-of-the-maestroex-equation-set">
<h2>Summary of the MAESTROeX&nbsp;Equation Set<a class="headerlink" href="#summary-of-the-maestroex-equation-set" title="Permalink to this headline">¶</a></h2>
<p>Here we summarize the equations solved by MAESTROeX. We refer the reader
to papers&nbsp;I through IV and the multilevel paper for the derivation
and motivation of the equation set. (Note: this ‘traditional’ algorithm
uses Strang-splitting for the reactions. An alternate implementation, using
spectral deferred corrections is outlined in Chapter&nbsp;<a class="reference external" href="#ch:sdc">[ch:sdc]</a>.)</p>
<div class="section" id="base-state">
<h3>Base State<a class="headerlink" href="#base-state" title="Permalink to this headline">¶</a></h3>
<p>The stratified atmosphere is characterized by a one-dimensional
time-dependent base state, defined by a base state density, <span class="math notranslate nohighlight">\(\rho_0\)</span>,
and a base state pressure, <span class="math notranslate nohighlight">\(p_0\)</span>, in hydrostatic equilibrum:</p>
<div class="math notranslate nohighlight">
\[\nabla p_0 = -\rho_0 |g| \er\]</div>
<p>The gravitational acceleration, <span class="math notranslate nohighlight">\(g\)</span> is either constant or a point-mass
with a <span class="math notranslate nohighlight">\(1/r^2\)</span> dependence (see §<a class="reference external" href="#sec:planarinvsqgravity">[sec:planarinvsqgravity]</a>) for plane-parallel geometries, or a monopole
constructed by integrating the base state density for spherical
geometries.</p>
<p>For the time-dependence, we will define a base state velocity, <span class="math notranslate nohighlight">\(w_0\)</span>,
which will adjust the base state from one hydrostatic equilibrum to
another in response to heating.</p>
<p>For convenience, we define a base state enthalphy, <span class="math notranslate nohighlight">\(h_0\)</span>, as needed
by laterally averaging the full enthalpy, <span class="math notranslate nohighlight">\(h\)</span>.</p>
</div>
<div class="section" id="continuity">
<h3>Continuity<a class="headerlink" href="#continuity" title="Permalink to this headline">¶</a></h3>
<p>Conservation of mass gives the same continuity equation we have with
compressible flow:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial \rho}{\partial t} + \nabla \cdot (\rho \Ub) = 0
\label{eq:flow:continuity}\]</div>
<p>Additionally, we carry species around which can react. The creation and destruction
of the species is described by their create rate, <span class="math notranslate nohighlight">\(\omegadot_k\)</span>, and the species
are defined by their mass fractions, <span class="math notranslate nohighlight">\(X_k \equiv \rho_k / \rho\)</span>, giving</p>
<div class="math notranslate nohighlight">
\[\frac{\partial \rho X_k}{\partial t} + \nabla \cdot (\rho \Ub X_k) = \rho \omegadot_k
\label{eq:flow:rhoX}\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\sum_k X_k = 1\]</div>
<p>The base state density evolution equation can be defined by laterally averaging the
full continuity equation, giving:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial\rho_0}{\partial t} = -\nabla\cdot(\rho_0 w_0 \eb_r),\label{eq:flow:base_density}\]</div>
<p>Subtracting these two yields the evolution equation for the perturbational
density, <span class="math notranslate nohighlight">\(\rho^\prime \equiv \rho - \rho_0\)</span>:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial\rho'}{\partial t} = -\Ub\cdot\nabla\rho' -
  \rho'\nabla\cdot\Ub - \nabla\cdot\left(\rho_0\Ubt\right) \label{eq:flow:rhoprime}\]</div>
<p>As first discussed in paper III and then refined in the multilevel paper, we capture
the changes that can occur due to significant convective
overturning by imposing the constraint that <span class="math notranslate nohighlight">\(\overline{\rho'}=0\)</span>
for all time. This gives</p>
<div class="math notranslate nohighlight">
\[\frac{\partial\overline{\rho'}}{\partial t} = -\nabla\cdot(\etarho\eb_r).\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\etarho = \overline{\left(\rho'\Ub\cdot\eb_r\right)}
\label{eq:flow:etarho}\]</div>
<p>In practice, we correct the drift by simply setting <span class="math notranslate nohighlight">\(\rho_0 =
\overline{\rho}\)</span> after the advective update of <span class="math notranslate nohighlight">\(\rho\)</span>. However we still need to
explicitly compute <span class="math notranslate nohighlight">\(\etarho\)</span> since it appears in other equations.</p>
</div>
<div class="section" id="constraint">
<h3>Constraint<a class="headerlink" href="#constraint" title="Permalink to this headline">¶</a></h3>
<p>The equation of state is cast into an elliptic constraint on the
velocity field by differentiating <span class="math notranslate nohighlight">\(p_0(\rho, s, X_k)\)</span> along particle
paths, giving:</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot (\beta_0 \Ub) =
   \beta_0 \left ( S - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} \right )
\label{eq:U divergence}\]</div>
<p>where <span class="math notranslate nohighlight">\(\beta_0\)</span> is a density-like variable that carries background
stratification, defined as</p>
<div class="math notranslate nohighlight">
\[\beta_0(r,t) = \rho_0(0,t)\exp\left(\int_0^r\frac{1}{\gammabar p_0}\frac{\partial p_0}{\partial r'}dr'\right),\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[S = -\sigma\sum_k\xi_k\omegadot_k + \frac{1}{\rho p_\rho}\sum_k p_{X_k}\omegadot_k + \sigma\Hnuc + \sigma\Hext + \frac{\sigma}{\rho} \nabla \cdot \kth \nabla T
\label{eq:flow:S}\]</div>
<p>where <span class="math notranslate nohighlight">\(p_{X_k} \equiv \left. \partial p / \partial X_k
\right|_{\rho,T,X_{j,j\ne k}}\)</span>, <span class="math notranslate nohighlight">\(\xi_k \equiv \left. \partial h /
\partial X_k \right |_{p,T,X_{j,j\ne k}},
p_\rho \equiv \left. \partial p/\partial \rho \right |_{T, X_k}\)</span>, and
<span class="math notranslate nohighlight">\(\sigma \equiv p_T/(\rho c_p p_\rho)\)</span>, with
<span class="math notranslate nohighlight">\(p_T \equiv \left. \partial p / \partial T \right|_{\rho, X_k}\)</span> and
<span class="math notranslate nohighlight">\(c_p \equiv \left.  \partial h / \partial T
\right|_{p,X_k}\)</span> is the specific heat at constant pressure. The last
term is only present if we are using thermal diffusion (use_thermal_diffusion = T). In this term, <span class="math notranslate nohighlight">\(\kth\)</span> is the thermal conductivity.</p>
<p>In this constraint, <span class="math notranslate nohighlight">\(\gammabar\)</span> is the lateral average of
<span class="math notranslate nohighlight">\(\Gamma_1 \equiv d\log p / d\log \rho |_s\)</span>. Using the lateral average
here makes it possible to cast the constraint as a
divergence. <a href="#id11"><span class="problematic" id="id12">:raw-latex:`\cite{KP:2012}`</span></a> discuss the general case where we want to
keep the local variations of <span class="math notranslate nohighlight">\(\Gamma_1\)</span> (and we explored this in paper
III). We also look at this in §&nbsp;<a class="reference external" href="#sec:flow:gamma1vary">[sec:flow:gamma1vary]</a>.</p>
</div>
<div class="section" id="momentum">
<h3>Momentum<a class="headerlink" href="#momentum" title="Permalink to this headline">¶</a></h3>
<p>The compressible momentum equation (written in terms of velocity is):</p>
<div class="math notranslate nohighlight">
\[\rho \frac{\partial \Ub}{\partial t} + \rho \Ub \cdot \nabla \Ub + \nabla p = -\rho |g| \er\]</div>
<p>Subtracting off the base state, and defining the perturbational
pressure (sometimes called the dynamic pressure) as <span class="math notranslate nohighlight">\(\pi \equiv p - p_0\)</span>,
and perturbational density as <span class="math notranslate nohighlight">\(\rho' \equiv \rho - \rho_0\)</span>, we have:</p>
<div class="math notranslate nohighlight">
\[\rho \frac{\partial \Ub}{\partial t} + \rho \Ub \cdot \nabla \Ub + \nabla \pi = -\rho' |g| \er\]</div>
<p>or</p>
<div class="math notranslate nohighlight">
\[\frac{\partial \Ub}{\partial t} + \Ub \cdot \nabla \Ub + \frac{1}{\rho} \nabla \pi =
   -\frac{\rho^\prime}{\rho} |g| \er\]</div>
<p>This is the form of the momentum equation that we solved in papers
I–IV and in the multilevel paper.</p>
<p>Several authors <a href="#id13"><span class="problematic" id="id14">:raw-latex:`\cite{KP:2012,VLBWZ:2013}`</span></a> explored the idea of energy
conservation in a low Mach number system and found that an additional
term (which can look like a buoyancy) is needed in the low Mach number
formulation, yielding:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial \Ub}{\partial t} + \Ub \cdot \nabla \Ub +
   \frac{\beta_0}{\rho} \nabla \left (\frac{p^\prime}{\beta_0} \right ) =
   -\frac{\rho^\prime}{\rho} |g| \er
\label{eq:flow:newmomentum}\]</div>
<p>This is the form that we enforce in MAESTROeX, and the choice is controlled
by use_alt_energy_fix.</p>
<p>We decompose the full velocity field into a base state velocity,
<span class="math notranslate nohighlight">\(w_0\)</span>, that governs the base state dynamics, and a local velocity,
<span class="math notranslate nohighlight">\(\Ubt\)</span>, that governs the local dynamics, i.e.,</p>
<div class="math notranslate nohighlight">
\[\Ub = w_0(r,t)\eb_r + \Ubt(\xb,t).\]</div>
<p>with
<span class="math notranslate nohighlight">\(\overline{(\Ubt\cdot\eb_r)} = 0\)</span> and
<span class="math notranslate nohighlight">\(w_0 = \overline{(\Ub\cdot\eb_r)}\)</span>—the motivation for this splitting was given in paper&nbsp;II.
The velocity evolution equations are then</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\frac{\partial w_0}{\partial t} &amp;= -w_0\frac{\partial w_0}{\partial
  r} - \frac{\beta_0}{\rho_0}\frac{\partial(\pi_0/\beta_0)}{\partial r},\label{eq:w0
  evolution}\\
%
\frac{\partial\Ubt}{\partial t} &amp;= -(\Ubt + w_0\er)\cdot\nabla\Ubt
  - \left(\Ubt\cdot\eb_r\right)\frac{\partial w_0}{\partial r}\eb_r -
\frac{\beta_0}{\rho}\nabla\left(\frac{\pi}{\beta_0} \right) +
\frac{\beta_0}{\rho_0}\frac{\partial(\pi_0/\beta_0)}{\partial r}\eb_r -
\frac{\rho-\rho_0}{\rho}g\eb_r.\label{eq:flow:utildeupd}\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\pi_0\)</span> is the base state component of the perturbational pressure.
By laterally averaging to equation (<a class="reference external" href="#eq:Udivergence">[eq:U divergence]</a>),
we obtain a divergence constraint for <span class="math notranslate nohighlight">\(w_0\)</span>:</p>
<div class="math notranslate nohighlight">
\[\nabla\cdot(\beta_0 w_0 \eb_r) =
    \beta_0\left(\Sbar - \frac{1}{\gammabar p_0}
           \frac{\partial p_0}{\partial t}\right).\label{eq:w0 divergence}\]</div>
<p>The divergence constraint for <span class="math notranslate nohighlight">\(\Ubt\)</span> can be found by subtracting
(<a class="reference external" href="#eq:w0divergence">[eq:w0 divergence]</a>) into (<a class="reference external" href="#eq:Udivergence">[eq:U divergence]</a>), resulting in</p>
<div class="math notranslate nohighlight">
\[\nabla\cdot\left(\beta_0\Ubt\right) = \beta_0\left(S-\Sbar\right).\label{eq:utilde divergence}\]</div>
</div>
<div class="section" id="base-state-expansion">
<h3>Base State Expansion<a class="headerlink" href="#base-state-expansion" title="Permalink to this headline">¶</a></h3>
<p>In practice, we calculate <span class="math notranslate nohighlight">\(w_0\)</span> by integrating
the one-dimensional divergence constraint. For a plane-parallel atmosphere, the
evolution is:</p>
<div class="math notranslate nohighlight">
\[\label{eq:flow:dw0dr_planar}
\frac{\partial w_0}{\partial r} = \Sbar - \frac{1}{\gammabar p_0} \etarho g \enskip\]</div>
<p>Then we define</p>
<div class="math notranslate nohighlight">
\[- \frac{\beta_0}{\rho_0} \frac{\partial (\pizero/\beta_0)}{\partial r} = \frac{\partial w_0}{\partial t} +
   w_0 \frac{\partial w_0}{\partial r} \enskip, \label{eq:pizero}\]</div>
<p>once <span class="math notranslate nohighlight">\(w_0\)</span> at the old and new times is known, and the advective term is computed explicitly.
Then we can include this for completeness in the update for <span class="math notranslate nohighlight">\(\ut.\)</span></p>
</div>
<div class="section" id="energy">
<h3>Energy<a class="headerlink" href="#energy" title="Permalink to this headline">¶</a></h3>
<p>Finally, we add an equation for specific enthalpy evolution to our
system. Strictly speaking this is not necessary to close the system,
but it becomes convenient at times to define the temperature.</p>
<div class="math notranslate nohighlight">
\[\frac{\partial(\rho h)}{\partial t} =
   -\nabla\cdot(\rho h\Ub) + \frac{Dp_0}{Dt} + \rho\Hnuc + \rho\Hext,\label{eq:flow:enthalpy}\]</div>
<p>We will often expand <span class="math notranslate nohighlight">\(Dp_0/Dt\)</span> as</p>
<div class="math notranslate nohighlight">
\[\frac{Dp_0}{Dt} = \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r}\]</div>
<p>where we defined</p>
<div class="math notranslate nohighlight">
\[\psi \equiv \frac{\partial p_0}{\partial t} + w_0 \frac{\partial p_0}{\partial r}\]</div>
<p>When we are using thermal diffusion, there will be an additional term in
the enthalpy equation (see §&nbsp;<a class="reference external" href="#sec:flow:diffusion">2.5</a>).</p>
<p>In paper&nbsp;III, we showed that for a plane-parallel atmosphere with
constant gravity, <span class="math notranslate nohighlight">\(\psi = \etarho g\)</span></p>
<p>At times, we will define a temperature equation by writing <span class="math notranslate nohighlight">\(h = h(T,p,X_k)\)</span>
and differentiating:</p>
<div class="math notranslate nohighlight">
\[\label{eq:flow:temp}
\frac{DT}{Dt} = \frac{1}{\rho c_p} \left\{ \left(1 - \rho h_p\right) \left
  [ \psi + (\Ubt \cdotb \er) \frac{\partial p_0}{\partial r} \right ]
 - \sum_k \rho \xi_k {\omegadot}_k
 + \rho \Hnuc + \rho \Hext \right \} \enskip  .\]</div>
<p>The base state evolution equations for density and enthalpy can be
found by averaging Eq&nbsp;<a class="reference external" href="#eq:flow:enthalpy">[eq:flow:enthalpy]</a>
over a layer of constant radius, resulting in</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
\frac{\partial(\rho h)_0}{\partial t} &amp;=&amp; -\nabla\cdot\left[(\rho h)_0w_0\eb_r\right] +
  \psi + \overline{\rho \Hnuc} + \overline{\rho \Hext}. \label{eq:flow:enthalpy_base}\end{aligned}\]</div>
<p>Subtracting it from the full enthalpy equation gives:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial(\rho h)'}{\partial t} = -\Ub\cdot\nabla(\rho h)' - (\rho h)'\nabla\cdot\Ub -
  \nabla\cdot\left[(\rho h)_0\Ubt\right] + \Ubt\cdot\nabla p_0
   + ( \rho\Hnuc - \overline{\rho \Hnuc}) + (\rho\Hext - \overline{\rho \Hext})
\label{eq:flow:rhohprime}\]</div>
</div>
</div>
<div class="section" id="time-advancement-algorithm">
<span id="sec-time-advancement-algorithm"></span><h2>Time Advancement Algorithm<a class="headerlink" href="#time-advancement-algorithm" title="Permalink to this headline">¶</a></h2>
<p>Here is the current description of the algorithm, based on the
description in the multilevel paper. The initialization has also been
included with more detail than was given in paper III. The main
driver for a single step of the algorithm is advance.f90—refer
to that code to see the sequence of functions called to implement each
step.</p>
<div class="section" id="definitions">
<h3>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h3>
<p>Below we define operations that will be referenced in
§&nbsp;<a class="reference external" href="#sec:flow:singlestep">[sec:flow:singlestep]</a>.</p>
<dl class="docutils">
<dt><strong>React State</strong>:math:<a href="#id15"><span class="problematic" id="id16">`</span></a>[rho^{inp},(rho h)^{inp},X_k^{inp},T^{inp}, (rhoHext)^{inp},</dt>
<dd>p_0^{inp}] rightarrow [rho^{outp}, (rho h)^{outp}, X_k^{outp},
T^{outp}, (rho omegadot_k)^{outp}, (rhoHnuc)^{outp}]`</dd>
</dl>
<p>evolves the species and enthalpy due to reactions through
<span class="math notranslate nohighlight">\(\Delta t/2\)</span> according to:</p>
<div class="math notranslate nohighlight">
\[\frac{dX_k}{dt} = \omegadot_k(\rho,X_k,T) ; \qquad
\frac{dT}{dt}   = \frac{1}{c_p} \left ( -\sum_k \xi_k  \omegadot_k  + \Hnuc \right ).\]</div>
<p>Here the temperature equation comes from Eq.&nbsp;<a class="reference external" href="#eq:flow:temp">[eq:flow:temp]</a> with <span class="math notranslate nohighlight">\(Dp_0/Dt = 0\)</span> for
the burning part of the evolution.</p>
<p>Full details of the
solution procedure can be found in Paper III. We then define:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho\omegadot_k)^{\outp} &amp;=&amp; \frac{\rho^{\outp} ( X_k^{\outp} - X_k^{\inp})}{\dt/2}, \\
(\rho h)^{\outp} &amp;=&amp; (\rho h)^{\inp} + \frac{\dt}{2} (\rho\Hnuc)^{\outp} + \frac{\dt}{2} (\rho\Hext)^{\inp}.\end{aligned}\end{split}\]</div>
<p>where the enthalpy update includes external heat sources <span class="math notranslate nohighlight">\((\rho\Hext)^{\inp}\)</span>.
As introduced in Paper IV, we update the temperature using <span class="math notranslate nohighlight">\(T^{\outp} =
T(\rho^\outp,h^\outp,X_k^\outp)\)</span> for planar geometry or <span class="math notranslate nohighlight">\(T^{\outp} =
T(\rho^\outp,p_0^\inp,X_k^\outp)\)</span> for spherical geometry, with this behavior
controlled by use_tfromp.
Note that the density remains unchanged within <strong>React State</strong>, i.e.,
<span class="math notranslate nohighlight">\(\rho^{\outp} = \rho^{\inp}\)</span>.</p>
<p>The source code for this operation can be found in react_state.f90.</p>
<dl class="docutils">
<dt><strong>Advect Base Density</strong>:math:<a href="#id17"><span class="problematic" id="id18">`</span></a>[rho_0^inp,w_0^inp] rightarrow</dt>
<dd>[rho_0^outp, rho_0^{outp,nph}]` is the process by which we</dd>
</dl>
<p>update the base state density through <span class="math notranslate nohighlight">\(\dt\)</span> in time. We keep the
time-centered edge states, <span class="math notranslate nohighlight">\(\rho_0^{\outp,\nph}\)</span>,
since they are used later in discretization of <span class="math notranslate nohighlight">\(\etarho\)</span> for planar problems.</p>
<dl class="docutils">
<dt>planar:</dt>
<dd><p class="first">We discretize equation (<a class="reference external" href="#eq:flow:base_density">[eq:flow:base_density]</a>) to
compute the new base state density,</p>
<div class="math notranslate nohighlight">
\[\rho_{0,j}^{\outp} = \rho_{0,j}^{\inp} - \frac{\dt}{\dr} \left [ \left( \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j+\myhalf} - \left( \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j-\myhalf} \right ].\]</div>
<p>We compute the time-centered edge states, <span class="math notranslate nohighlight">\({\rho_0}^{\outp,\nph}_{j\pm\myhalf}\)</span>,
by discretizing an expanded form of equation (<a class="reference external" href="#eq:flow:base_density">[eq:flow:base_density]</a>):</p>
<div class="math notranslate nohighlight">
\[\frac{\partial \rho_0}{\partial t} + w_0 \frac{\partial \rho_0}{\partial r} = - \rho_0 \frac{\partial w_0}{\partial r},\]</div>
<p class="last">where the right hand side is used as the force term.</p>
</dd>
<dt>spherical:</dt>
<dd><p class="first">The base state density update now includes the area factors in the
divergences:</p>
<div class="math notranslate nohighlight">
\[\rho_{0,j}^{\outp} = \rho_{0,j}^{\inp} - \frac{1}{r_j^2} \frac{\dt}{\dr} \left [ \left( r^2 \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j+\myhalf} - \left( r^2 \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j-\myhalf} \right].\]</div>
<p>In order to compute the time-centered edge states, an additional geometric
term is added to the forcing, due to the spherical discretization of
(<a class="reference external" href="#eq:flow:base_density">[eq:flow:base_density]</a>):</p>
<div class="last math notranslate nohighlight">
\[\frac{\partial \rho_0}{\partial t} + w_0 \frac{\partial \rho_0}{\partial r} = - \rho_0 \frac{\partial w_0}{\partial r} - \frac{2 \rho_0 w_0}{r}.\]</div>
</dd>
</dl>
<p>The source code for this operation can be found in advect_base.f90.</p>
<dl class="docutils">
<dt><strong>Enforce HSE</strong>:math:<a href="#id19"><span class="problematic" id="id20">`</span></a>[p_0^{inp},rho_0^{inp}]</dt>
<dd>rightarrow [p_0^{outp}]` has replaced <strong>Advect Base Pressure</strong></dd>
</dl>
<p>from Paper III as the process by which we update the base state
pressure. Rather than discretizing the evolution equation for
<span class="math notranslate nohighlight">\(p_0\)</span>, we enforce hydrostatic equilibrium directly, which is numerically simpler
and analytically equivalent. We first set
<span class="math notranslate nohighlight">\(p_{0,j=0}^{\outp} = p_{0,j=0}^{\inp}\)</span> and then update <span class="math notranslate nohighlight">\(p_0^\outp\)</span> using:</p>
<div class="math notranslate nohighlight">
\[p_{0,j+1}^{\outp} = p_{0,j}^{\outp} + \Delta r g_{j+\myhalf}\frac{\left(\rho_{0,j+1}^{\inp}+\rho_{0,j}^{\inp}\right)}{2},\]</div>
<p>where <span class="math notranslate nohighlight">\(g=g(\rho_0^\inp)\)</span>. As soon as <span class="math notranslate nohighlight">\(\rho_{0,j}^\inp &lt; \rho_{\rm cutoff}\)</span>, we set
<span class="math notranslate nohighlight">\(p_{0,j+1}^\outp = p_{0,j}^\outp\)</span> for all remaining values of <span class="math notranslate nohighlight">\(j\)</span>.
Then we compare <span class="math notranslate nohighlight">\(p_{0,j_{\rm max}}^\outp\)</span> with <span class="math notranslate nohighlight">\(p_{0,j_{\rm max}}^\inp\)</span> and offset
every element in <span class="math notranslate nohighlight">\(p_0^\outp\)</span> so that <span class="math notranslate nohighlight">\(p_{0,j_{\rm max}}^\outp = p_{0,j_{\rm max}}^\inp\)</span>.
We are effectively using the location where the <span class="math notranslate nohighlight">\(\rho_0^\inp\)</span> drops below
<span class="math notranslate nohighlight">\(\rho_{\rm cutoff}\)</span> as the starting point for integration.</p>
<p>The source code for this operation can be found in enforce_HSE.f90.</p>
<p><strong>Advect Base Enthalpy</strong><span class="math notranslate nohighlight">\([(\rho h)_0^\inp,w_0^\inp,\psi^\inp] \rightarrow [(\rho h)_0^\outp]\)</span>
is the process by which we update the base state enthalpy through <span class="math notranslate nohighlight">\(\dt\)</span> in time.</p>
<dl class="docutils">
<dt>planar:</dt>
<dd><p class="first">We discretize equation (<a class="reference external" href="#eq:flow:enthalpy_base">[eq:flow:enthalpy_base]</a>), neglecting reaction
source terms, to compute the new base state enthalpy,</p>
<div class="math notranslate nohighlight">
\[(\rho h)_{0,j}^{\outp} = (\rho h)_{0,j}^{\inp} - \frac{\dt}{\Delta r} \left\{ \left[ (\rho h)_0^{\nph} w_0^{\inp}\right]_{j+\myhalf} - \left[ (\rho h)_0^{\nph} w_0^{\inp}\right]_{j-\myhalf} \right\} + \dt\psi_j^{\inp}.\]</div>
<p>We compute the time-centered edge states, <span class="math notranslate nohighlight">\((\rho h)_0^{\nph}\)</span>, by discretizing
an expanded form of equation (<a class="reference external" href="#eq:flow:enthalpy_base">[eq:flow:enthalpy_base]</a>):</p>
<div class="last math notranslate nohighlight">
\[\frac{\partial (\rho h)_0}{\partial t} + w_0 \frac{\partial (\rho h)_0}{\partial r} = -(\rho h)_0 \frac{\partial w_0}{\partial r} + \psi.\]</div>
</dd>
<dt>spherical:</dt>
<dd><p class="first">The base state enthalpy update now includes the area factors
in the divergences:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho h)_{0,j}^{\outp} &amp;=&amp; (\rho h)_{0,j}^{\inp} \nonumber \\
&amp;&amp; - \frac{1}{r_j^2} \frac{\dt}{\dr} \left \{ \left[ r^2 (\rho h)_0^{\nph} w_0^{\inp}\right]_{j+\myhalf} - \left[ r^2 (\rho h)_0^{\nph} w_0^{\inp}\right]_{j-\myhalf} \right\} +\dt\psi^{\inp,\nph}.\nonumber\\\end{aligned}\end{split}\]</div>
<p>In order to compute the time-centered edge states, an additional geometric
term is added to the forcing, due to the spherical discretization of
(<a class="reference external" href="#eq:flow:enthalpy_base">[eq:flow:enthalpy_base]</a>):</p>
<div class="last math notranslate nohighlight">
\[\frac{\partial (\rho h)_0}{\partial t} + w_0 \frac{\partial (\rho h)_0}{\partial r} = -(\rho h)_0 \frac{\partial w_0}{\partial r} - \frac{2 (\rho h)_0 w_0}{r} + \psi.\]</div>
</dd>
</dl>
<p>The source code for this operation can be found in advect_base.f90.</p>
<p><strong>Computing :math:`w_0`</strong>[Sec:Computing w0]
Here we describe the process by which we compute <span class="math notranslate nohighlight">\(w_0\)</span>. The arguments
are different for planar and spherical geometries.</p>
<p><strong>Compute</strong> <span class="math notranslate nohighlight">\(w_0\)</span> <strong>Planar</strong>
<span class="math notranslate nohighlight">\([\Sbar^{\inp},\gammabar^{\inp}, p_0^{\inp},\psi^{\inp}]\rightarrow [w_0^{\outp}]\)</span>:</p>
<p>In Paper III, we showed that <span class="math notranslate nohighlight">\(\psi=\etarho g\)</span> for planar geometries,
and derived derived Eq.&nbsp;<a class="reference external" href="#eq:flow:dw0dr_planar">[eq:flow:dw0dr_planar]</a> as an alternate
expression for Eq.&nbsp;<a class="reference external" href="#eq:w0divergence">[eq:w0 divergence]</a>. We discretize this as:</p>
<div class="math notranslate nohighlight">
\[\frac{w_{0,j+\myhalf}^\outp-w_{0,j-\myhalf}^\outp}{\Delta r} = \left(\Sbar^{\inp} - \frac{1}{\gammabar^{\inp} p_0^{\inp}}\psi^{\inp}\right)_j,\]</div>
<p>with <span class="math notranslate nohighlight">\(w_{0,-\myhalf}=0\)</span>.</p>
<p><strong>Compute</strong> <span class="math notranslate nohighlight">\(w_0\)</span> <strong>Spherical</strong>
:math:<a href="#id21"><span class="problematic" id="id22">`</span></a>[Sbar^{inp},gammabar^{inp},rho_0^{inp},p_0^{inp},etarho^{inp}]</p>
<blockquote>
<div>rightarrow[w_0^{outp}]`:</div></blockquote>
<p>We begin with equation (<a class="reference external" href="#eq:w0divergence">[eq:w0 divergence]</a>) written in spherical coordinates:</p>
<div class="math notranslate nohighlight">
\[\frac{1}{r^2}\frac{\partial}{\partial r} \left (r^2 \beta_0 w_0 \right ) = \beta_0 \left ( \Sbar - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} \right ).\]</div>
<p>We expand the spatial derivative and recall from Paper I that</p>
<div class="math notranslate nohighlight">
\[\frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial r} = \frac{1}{\beta_0} \frac{\partial \beta_0}{\partial r},\]</div>
<p>giving:</p>
<div class="math notranslate nohighlight">
\[\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) = \Sbar - \frac{1}{\gammabar p_0} \underbrace{\left( \frac{\partial p_0}{\partial t} + w_0 \frac{\partial p_0}{\partial r} \right)}_{\psi}.\label{eq:psi def}\]</div>
<p>We solve this equation for <span class="math notranslate nohighlight">\(w_0\)</span> as described in Appendix&nbsp;B of the multilevel paper.</p>
<p>The source code for this operation can be found in make_w0.f90.</p>
</div>
<div class="section" id="sec-flow-singlestep-single-step">
<h3>[sec:flow:singlestep] Single Step<a class="headerlink" href="#sec-flow-singlestep-single-step" title="Permalink to this headline">¶</a></h3>
<p>1em</p>
<p><em>Initialization</em></p>
<p>This step remains unchanged from Paper III. See §<a class="reference external" href="#Sec:Initialization">3</a>
for details. The initialization step only occurs at the beginning of the simulation.
The initial values for <span class="math notranslate nohighlight">\(\Ub^0, \rho^0, (\rho h)^0, X_k^0, T^0,
\rho_0^0, p_0^0\)</span>, and <span class="math notranslate nohighlight">\(\overline{\Gamma_1^0}\)</span> are specified from the problem-dependent
initial conditions. The initial time step, <span class="math notranslate nohighlight">\(\dt^0\)</span>, is computed as in
Paper III. Finally, initial
values for <span class="math notranslate nohighlight">\(w_0^{-\myhalf}, \etarho^{-\myhalf}, \psi^{-\myhalf},
\pi^{-\myhalf}, S^0\)</span>, and <span class="math notranslate nohighlight">\(S^1\)</span> come from a preliminary pass through
the algorithm.</p>
<p><em>React the full state through the first time interval of :math:`dt / 2.`</em></p>
<dl class="docutils">
<dt>Call <strong>React State</strong>:math:<a href="#id23"><span class="problematic" id="id24">`</span></a>[rho^n, (rho h)^n, X_k^n, T^n, (rhoHext)^n, p_0^n]</dt>
<dd>rightarrow [rho^{(1)},(rho h)^{(1)},X_k^{(1)},T^{(1)},(rho omegadot_k)^{(1)},(rho Hnuc)^{(1)}]`.</dd>
</dl>
<p><em>Compute the provisional time-centered expansion,
:math:`S^{nph,starstar}`, provisional base state velocity,
:math:`w_0^{nph,star}`, and provisional base state velocity forcing.</em></p>
<p>Compute <span class="math notranslate nohighlight">\(S^{\nph,\star\star}\)</span>. We compute an estimate for the
time-centered expansion term in the velocity divergence constraint,
as given in Eq.&nbsp;<a class="reference external" href="#eq:flow:S">[eq:flow:S]</a>. For the first time step (<span class="math notranslate nohighlight">\(n=0\)</span>),
we set</p>
<div class="math notranslate nohighlight">
\[S^{n+\myhalf,\star\star} = \frac{S^0 + S^1}{2},\]</div>
<p>where <span class="math notranslate nohighlight">\(S^1\)</span> is found during initialization. For other time steps
<span class="math notranslate nohighlight">\((n \ne 0)\)</span>, following <a href="#id25"><span class="problematic" id="id26">:raw-latex:`\cite{SNe}`</span></a>, we extrapolate
to the half-time using <span class="math notranslate nohighlight">\(S\)</span> at the previous and current
time levels</p>
<div class="math notranslate nohighlight">
\[S^{\nph,\star\star} = S^n + \frac{\dt^n}{2} \frac{S^n - S^{n-1}}{\dt^{n-1}}.\]</div>
<p>Next, compute</p>
<div class="math notranslate nohighlight">
\[\overline{S^{\nph,\star\star}} = {\mathrm{\bf Avg}} \left(S^{\nph,\star\star}\right).\]</div>
<p>Compute <span class="math notranslate nohighlight">\(w_0^{\nph,\star}\)</span>.</p>
<div class="line-block">
<div class="line">For planar geometry, call</div>
<div class="line"><strong>Compute</strong> <span class="math notranslate nohighlight">\(w_0\)</span> <strong>Planar</strong><span class="math notranslate nohighlight">\([\overline{S^{\nph,\star\star}},\overline{\Gamma_1^n},p_0^n,\psi^{n-\myhalf}] \rightarrow [w_0^{\nph,\star}]\)</span>.</div>
</div>
<div class="line-block">
<div class="line">For spherical geometry, call</div>
<div class="line"><strong>Compute</strong> <span class="math notranslate nohighlight">\(w_0\)</span> <strong>Spherical</strong><span class="math notranslate nohighlight">\([\overline{S^{\nph,\star\star}},\overline{\Gamma_1^n},\rho_0^n,p_0^n,\etarho^{n-\myhalf}] \rightarrow [w_0^{\nph,\star}]\)</span>.</div>
</div>
<p>Compute the provisional base state velocity forcing, using equation (38)
from paper&nbsp;III,</p>
<div class="math notranslate nohighlight">
\[-\frac{\beta_0}{\rho_0} \frac{\partial (\pi_0/\beta_0)}{\partial r} = \frac{\partial w_0}{\partial t} + w_0 \frac{\partial w_0}{\partial r}, \label{eq:pizero}\]</div>
<p>with the following discretization:</p>
<div class="math notranslate nohighlight">
\[\left ( \frac{\beta_0}{\rho_0} \frac{\partial (\pi_0/\beta_0)}{\partial r} \right )^{n,\star} = -\frac{w_0^{\nph,\star} - w_0^\nmh}{(\dt^n+\dt^{n-1})/2} - w_0^{n,\star} \left(\frac{\partial w_0}{\partial r}\right)^{n,\star},\]</div>
<p>where <span class="math notranslate nohighlight">\(w_0^{n,\star}\)</span> and <span class="math notranslate nohighlight">\((\partial w_0 / \partial r)^{n,\star}\)</span> are defined as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
w_0^{n,\star} &amp;=&amp; \frac{\dt^{n} w_0^{\nmh} + \dt^{n-1} w_0^{\nph,\star}}{\dt^n+\dt^{n-1}}, \\
\left(\frac{\partial w_0}{\partial r}\right)^{n,\star} &amp;=&amp; \frac{1}{\dt^n+\dt^{n-1}}\left [ \dt^{n} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nmh} + \dt^{n-1} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nph,\star} \right ].\nonumber \\\end{aligned}\end{split}\]</div>
<p>If <span class="math notranslate nohighlight">\(n=0\)</span>, we use <span class="math notranslate nohighlight">\(\dt^{-1} = \dt^0\)</span>.</p>
<p><em>Construct the provisional time-centered advective velocity on
edges, :math:`uadvone`.</em></p>
<p>The local velocity field is described by Eq.&nbsp;<a class="reference external" href="#eq:flow:utildeupd">[eq:flow:utildeupd]</a>.
From this, we compute time-centered edge
velocities, <span class="math notranslate nohighlight">\(\uadvonedag\)</span>, using
<span class="math notranslate nohighlight">\(\Ub = \Ubt^n + w_0^{\nph,\star}\)</span>. The <span class="math notranslate nohighlight">\(\dagger\)</span> superscript refers to the
fact that the predicted velocity field does not satisfy the divergence
constraint. We then construct <span class="math notranslate nohighlight">\(\uadvone\)</span> from <span class="math notranslate nohighlight">\(\uadvonedag\)</span>
using a MAC projection, as described in detail in Appendix B of Paper III.
We note that <span class="math notranslate nohighlight">\(\uadvone\)</span> satisfies the discrete version of
<span class="math notranslate nohighlight">\(\overline{(\uadvone\cdot\eb_r)}=0\)</span> as well as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\nabla \cdot \left(\beta_0^n \uadvone\right) &amp;=&amp; \beta_0^n \left(S^{\nph,\star\star} - \overline{S^{\nph,\star\star}}\right),\\
 \beta_0^n &amp;=&amp; \beta_0 \left(\rho_0^n, p_0^n, \overline{\Gamma_1^n}\right),\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\beta_0\)</span> is computed as described in Appendix C of Paper III (although
note that an alternate procedure that uses linear reconstruction of <span class="math notranslate nohighlight">\(g\)</span> in
constructing <span class="math notranslate nohighlight">\(\beta_0\)</span> is enabled with use_linear_grav_in_beta).</p>
<p><em>Advect the base state and full state through a time interval of :math:`dt.`</em></p>
<p>Update <span class="math notranslate nohighlight">\(\rho_0\)</span>, saving the time-centered density at radial edges by calling</p>
<p><strong>Advect Base Density</strong><span class="math notranslate nohighlight">\([\rho_0^{n},w_0^{\nph,\star}] \rightarrow [\rho_0^{(2a),\star}, \rho_0^{\nph,\star,\pred}]\)</span>.</p>
<p>Update <span class="math notranslate nohighlight">\((\rho X_k)\)</span> using a discretized version of the species
continuity equation, Eq.&nbsp;<a class="reference external" href="#eq:flow:rhoX">[eq:flow:rhoX]</a>, where we omit the
reaction terms, which were already accounted for in <strong>React State</strong>:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial (\rho X_k)}{\partial t} + \nabla \cdot (\Ub \rho X_k) = 0 \enskip .
\label{eq:species}\]</div>
<p>The update consists of two steps:</p>
<ol class="arabic">
<li><p class="first">Compute the time-centered species edge states, <span class="math notranslate nohighlight">\((\rho X_k)^{\nph,\star,\pred}\)</span>,
for the conservative update of <span class="math notranslate nohighlight">\((\rho X_k)^{(1)}\)</span>.</p>
<div class="line-block">
<div class="line">There are a variety of choices of quantities to predict to the
edges (controlled by species_pred_type—see Chapter&nbsp;<a class="reference external" href="#ch:pert">[ch:pert]</a>).
By default, we use the equations</div>
</div>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\frac{\partial\rho'}{\partial t} &amp;=&amp; -\Ub\cdot\nabla\rho' -
     \rho'\nabla\cdot\Ub - \nabla\cdot\left(\rho_0\Ubt\right),
     \label{eq:Perturbational Density}  \\
\frac{\partial X_k}{\partial t} &amp;=&amp; -\Ub\cdot\nabla X_k +
     \omegadot_k. \label{eq:Primitive Species}\end{aligned}\end{split}\]</div>
<p>to
predict <span class="math notranslate nohighlight">\(\rho^{'(1)} = \rho^{(1)} - \rho_0^n\)</span> and
<span class="math notranslate nohighlight">\(X_k^{(1)} = (\rho  X_k)^{(1)} / \rho^{(1)}\)</span> to time-centered edges using
<span class="math notranslate nohighlight">\(\Ub = \uadvone+w_0^{\nph,\star}\eb_r\)</span>, yielding <span class="math notranslate nohighlight">\(\rho^{'\nph,\star,\pred}\)</span>
and <span class="math notranslate nohighlight">\(X_k^{\nph,\star,\pred}\)</span>.
We convert the perturbational density to full state density using</p>
<div class="math notranslate nohighlight">
\[\rho^{\nph,\star,\pred} = \rho^{'\nph,\star,\pred} + \frac{\rho_0^n + \rho_0^{(2a),\star}}{2},\]</div>
<p>where the base state density terms are mapped to Cartesian edges.
Then,</p>
</div></blockquote>
<div class="line-block">
<div class="line"><span class="math notranslate nohighlight">\((\rho X_k)^{\nph,\star,\pred} = \rho^{\nph,\star,\pred} \, X_k^{\nph,\star,\pred}\)</span>.</div>
</div>
</li>
<li><p class="first">Evolve <span class="math notranslate nohighlight">\((\rho X_k)^{(1)} \rightarrow (\rho X_k)^{(2),\star}\)</span> using</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho X_k)^{(2),\star} &amp;=&amp; (\rho X_k)^{(1)} \nonumber \\
&amp;&amp; - \dt \left\{ \nabla \cdot \left[ \left(\uadvone+w_0^{\nph,\star} \eb_r\right) (\rho X_k)^{\nph,\star,\pred} \right] \right\},\nonumber \\\end{aligned}\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\rho^{(2),\star} = \sum_k (\rho X_k)^{(2),\star},
\qquad
X_k^{(2),\star} = (\rho X_k)^{(2),\star} / \rho^{(2),\star}.\]</div>
</li>
</ol>
<p>Define a radial edge-centered <span class="math notranslate nohighlight">\(\etarho^{\nph,\star}\)</span> (Eq.&nbsp;<a class="reference external" href="#eq:flow:etarho">[eq:flow:etarho]</a>).</p>
<p>For planar geometry, since <span class="math notranslate nohighlight">\(\etarho = \overline{\rho'(\Ub\cdot\eb_r)} = \overline{\rho(\Ub\cdot\eb_r)}-\overline{\rho_0(\Ub\cdot\eb_r}) = \overline{\rho(\Ub\cdot\eb_r)} - \rho_0w_0\)</span>,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
 \etarho^{\nph,\star} &amp;=&amp;  {\rm {\bf Avg}} \sum_k \left[ \left(\uadvone \cdot \eb_r + w_0^{\nph,\star}\right) (\rho X_k)^{\nph,\star,\pred} \right]\nonumber\\
&amp;&amp; - w_0^{\nph,\star} \rho_0^{\nph,\star,\pred},\end{aligned}\end{split}\]</div>
<p>For spherical geometry, first construct
<span class="math notranslate nohighlight">\(\etarho^{{\rm cart},\nph,\star} =
[\rho'(\Ub\cdot\eb_r)]^{\nph,\star}\)</span> on Cartesian cell centers using:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\etarho^{{\rm cart},\nph,\star} &amp;=&amp; \left[\left(\frac{\rho^{(1)}+\rho^{(2),\star}}{2}\right)-\left(\frac{\rho_0^n+\rho_0^{(2a),\star}}{2}\right)\right] \nonumber \\
&amp;&amp;\cdot \left( \uadvone \cdot \eb_r  + w_0^{\nph,\star}\right).\end{aligned}\end{split}\]</div>
<p>Then,</p>
<div class="math notranslate nohighlight">
\[\etarho^{\nph,\star} = {\rm {\bf Avg}}\left(\etarho^{{\rm cart},\nph,\star}\right).\]</div>
<p>This gives a radial cell-centered <span class="math notranslate nohighlight">\(\etarho^{\nph,\star}\)</span>. To get
<span class="math notranslate nohighlight">\(\etarho^{\nph,\star}\)</span> at radial edges, average the two neighboring
radial cell-centered values.</p>
<p>Correct <span class="math notranslate nohighlight">\(\rho_0\)</span> by setting <span class="math notranslate nohighlight">\(\rho_0^{n+1,\star} =\)</span> <strong>Avg</strong><span class="math notranslate nohighlight">\((\rho^{(2),\star})\)</span>.</p>
<p>Update <span class="math notranslate nohighlight">\(p_0\)</span> by calling
<strong>Enforce HSE</strong><span class="math notranslate nohighlight">\([p_0^n,\rho_0^{n+1,\star}] \rightarrow [p_0^{n+1,\star}]\)</span>.</p>
<p>Compute <span class="math notranslate nohighlight">\(\psi^{\nph,\star}\)</span>.</p>
<p>For planar geometry,</p>
<div class="math notranslate nohighlight">
\[\psi_j^{\nph,\star} = \frac{1}{2} \left(\eta_{\rho,j-\myhalf}^{\nph,\star}
+ \eta_{\rho,j+\myhalf}^{\nph,\star}\right) g.\]</div>
<p>For spherical geometry, first compute:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\overline{\Gamma_1^{(1)}} &amp;=&amp; {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{(1)}, p_0^{n}, X_k^{(1)}\right) \right]  , \\
\overline{\Gamma_1^{(2),\star}} &amp;=&amp; {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{(2),\star}, p_0^{n+1,\star}, X_k^{(2),\star}\right) \right].\end{aligned}\end{split}\]</div>
<p>Then, define <span class="math notranslate nohighlight">\(\psi^{\nph,\star}\)</span> using equation (<a class="reference external" href="#eq:psidef">[eq:psi def]</a>)</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\psi_j^{\nph,\star}
&amp;=&amp; \left(\frac{\overline{\Gamma_1^{(1)}}+\overline{\Gamma_1^{(2),\star}}}{2}\right)_j
\left(\frac{p_0^n+p_0^{n+1,\star}}{2}\right)_j \nonumber \\
&amp;&amp; \left \{ \overline{S_j^{\nph,\star}} - \frac{1}{r_j^2} \left [ \left(r^2 w_0^{\nph,\star}\right)_{j+\myhalf} - \left(r^2 w_0^{\nph,\star}\right)_{j-\myhalf} \right ] \right \}.\nonumber \\\end{aligned}\end{split}\]</div>
<div class="line-block">
<div class="line">Update <span class="math notranslate nohighlight">\((\rho h)_0\)</span>. First, compute <span class="math notranslate nohighlight">\((\rho h)_0^n =\)</span> <strong>Avg</strong><span class="math notranslate nohighlight">\([(\rho h)^{(1)}]\)</span>.
Then, call</div>
<div class="line"><strong>Advect Base Enthalpy</strong><span class="math notranslate nohighlight">\([(\rho h)_0^{n}, w_0^{\nph,\star}, \psi^{\nph,\star}] \rightarrow [(\rho h)_0^{n+1,\star}]\)</span>.</div>
</div>
<p>Update the enthalpy using a discretized version of the enthalpy
evolution equation (Eq.&nbsp;<a class="reference external" href="#eq:flow:enthalpy">[eq:flow:enthalpy]</a>), again omitting the reaction and heating terms
since we already accounted for
them in <strong>React State</strong>. This equation takes the form:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial (\rho h)}{\partial t}  = - \nabla \cdot (\Ub \rho h) + \psi + (\Ubt \cdot \eb_r) \frac{\partial p_0}{\partial r}.\]</div>
<p>For spherical geometry, we solve the
analytically equivalent form,</p>
<div class="math notranslate nohighlight">
\[\frac{\partial (\rho h)}{\partial t}  = - \nabla \cdot (\Ub \rho h) + \psi + \nabla \cdot (\Ubt p_0) - p_0 \nabla \cdot \Ubt,\]</div>
<p>which experience has shown to minimize the drift from thermodynamic
equilibrium. The update consists of two steps:</p>
<p>Compute the time-centered enthalpy edge state, <span class="math notranslate nohighlight">\((\rho h)^{\nph,\star,\pred},\)</span>
for the conservative update of <span class="math notranslate nohighlight">\((\rho h)^{(1)}\)</span>. There are a
variety of quantities that we can predict to the interfaces here
(controlled by enthalpy_pred_type—see
Chapter&nbsp;<a class="reference external" href="#ch:pert">[ch:pert]</a>). For the default case, we use the
perturbational enthalpy equation, Eq.&nbsp;<a class="reference external" href="#eq:flow:rhohprime">[eq:flow:rhohprime]</a>, neglecting reactions,</p>
<div class="math notranslate nohighlight">
\[\frac{\partial(\rho h)'}{\partial t} = -\Ub\cdot\nabla(\rho h)' -
   (\rho h)'\nabla\cdot\Ub - \nabla\cdot\left[(\rho h)_0\Ubt\right] + \Ubt\cdot\nabla p_0
    \label{eq:Perturbational Enthalpy}.\]</div>
<p>to predict
<span class="math notranslate nohighlight">\((\rho h)' = (\rho h)^{(1)} - (\rho h)_0^n\)</span> to time-centered edges,
using <span class="math notranslate nohighlight">\(\Ub = \uadvone+w_0^{\nph,\star} \eb_r\)</span>,
yielding <span class="math notranslate nohighlight">\((\rho h)^{'\nph,\star,\pred}\)</span>. We convert the perturbational
enthalpy to a full state enthalpy using</p>
<div class="math notranslate nohighlight">
\[(\rho h)^{\nph,\star,\pred} = (\rho h)^{'\nph,\star,\pred} + \frac{(\rho h)_0^n + (\rho h)_0^{n+1,\star}}{2}.\]</div>
<p>For planar geometry, we map <span class="math notranslate nohighlight">\((\rho h)_0\)</span> directly to Cartesian edges.
In spherical geometry, our experience has shown that a slightly different
approach leads to reduced discretization errors. We first map
<span class="math notranslate nohighlight">\(h_0 \equiv (\rho h)_0/\rho_0\)</span> and <span class="math notranslate nohighlight">\(\rho_0\)</span> to Cartesian edges separately,
and then multiply these terms to get <span class="math notranslate nohighlight">\((\rho h)_0\)</span>.</p>
<p>Evolve <span class="math notranslate nohighlight">\((\rho h)^{(1)} \rightarrow (\rho h)^{(2),\star}\)</span>.</p>
<p>For planar geometry,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho h)^{(2),\star}
&amp;=&amp; (\rho h)^{(1)} \nonumber \\
&amp;&amp;- \dt \left\{ \nabla \cdot \left[ \left(\uadvone+w_0^{\nph,\star} \eb_r\right) (\rho h)^{\nph,\star,\pred} \right] \right\} \nonumber \\
&amp;&amp; + \dt \left(\uadvone \cdot \eb_r\right) \left(\frac{\partial p_0}{\partial r} \right)^{n} + \dt \psi^{\nph,\star},\end{aligned}\end{split}\]</div>
<p>For spherical geometry,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho h)^{(2),\star}
&amp;=&amp; (\rho h)^{(1)} \nonumber \\
&amp;&amp;- \dt \left\{ \nabla \cdot \left[ \left(\uadvone+w_0^{\nph,\star} \eb_r\right) (\rho h)^{\nph,\star,\pred} \right] \right\} \nonumber \\
&amp;&amp; + \dt \left \{ \nabla \cdot \left (\uadvone p_0^{n} \right ) - p_0^{n} \nabla \cdot \uadvone \right \} \nonumber \\
&amp;&amp;+ \dt \psi^{\nph,\star},\end{aligned}\end{split}\]</div>
<p>Then, for each Cartesian cell where <span class="math notranslate nohighlight">\(\rho^{(2),\star} &lt; \rho_\mathrm{cutoff}\)</span>,
we recompute enthalpy using</p>
<div class="math notranslate nohighlight">
\[(\rho h)^{(2),\star} = \rho^{(2),\star}h\left(\rho^{(2),\star},p_0^{n+1,\star},X_k^{(2),\star}\right).\]</div>
<p>This behavior is controlled by do_eos_h_above_cutoff.</p>
<p>Update the temperature using the equation of state:
:math:<a href="#id27"><span class="problematic" id="id28">`</span></a>T^{(2),star} =</p>
<blockquote>
<div>T(rho^{(2),star}, h^{(2),star}, X_k^{(2),star})` (planar geometry) or</div></blockquote>
<dl class="docutils">
<dt>:math:<a href="#id29"><span class="problematic" id="id30">`</span></a>T^{(2),star} =</dt>
<dd>T(rho^{(2),star}, p_0^{n+1,star}, X_k^{(2),star})` (spherical geometry).</dd>
</dl>
<p>As before, this behavior is controlled by use_tfromp.</p>
<p><em>React the full state through a second time interval of :math:`dt / 2.`</em></p>
<div class="line-block">
<div class="line">Call <strong>React State</strong><span class="math notranslate nohighlight">\([ \rho^{(2),\star},(\rho h)^{(2),\star}, X_k^{(2),\star}, T^{(2),\star},
(\rho\Hext)^{(2),\star}, p_0^{n+1,\star}]\)</span></div>
<div class="line"><span class="math notranslate nohighlight">\({}\hfill   \rightarrow [ \rho^{n+1,\star},(\rho h)^{n+1,\star}, X_k^{n+1,\star}, T^{n+1,\star}, (\rho \omegadot_k)^{(2),\star}, (\rho \Hnuc)^{(2),\star} ].\)</span></div>
</div>
<p><em>Compute the time-centered expansion, :math:`S^{nph,star}`, base state
velocity, :math:`w_0^{nph}`, and base state velocity forcing.</em></p>
<p>Compute <span class="math notranslate nohighlight">\(S^{\nph,\star}\)</span>. First, compute <span class="math notranslate nohighlight">\(S^{n+1,\star}\)</span> with</p>
<div class="math notranslate nohighlight">
\[S^{n+1,\star} =  -\sigma  \sum_k  \xi_k  (\omegadot_k)^{(2),\star}  +
   \frac{1}{\rho^{n+1,\star} p_\rho} \sum_k p_{X_k}  ({\omegadot}_k)^{(2),\star} +
   \sigma \Hnuc^{(2),\star} + \sigma \Hext^{(2),\star},\]</div>
<dl class="docutils">
<dt>where :math:<a href="#id31"><span class="problematic" id="id32">`</span></a>(omegadot_k)^{(2),star} = (rho omegadot_k)^{(2),star} /</dt>
<dd>rho^{(2),star}` and the thermodynamic quantities are defined using</dd>
</dl>
<p><span class="math notranslate nohighlight">\(\rho^{n+1,\star}, X_k^{n+1,\star},\)</span> and <span class="math notranslate nohighlight">\(T^{n+1,\star}\)</span> as inputs to
the equation of state. If we are using diffusion then we would include the diffusion
term in <span class="math notranslate nohighlight">\(S\)</span>. Then, define</p>
<div class="math notranslate nohighlight">
\[\overline{S^{\nph,\star}} = {\mathrm{\bf Avg}} (S^{\nph,\star}),
\qquad
 S^{\nph.\star} = \frac{S^n + S^{n+1,\star}}{2},\]</div>
<p>Compute <span class="math notranslate nohighlight">\(w_0^{\nph}\)</span>. First, define</p>
<div class="math notranslate nohighlight">
\[\overline{\Gamma_1^{\nph,\star}} = \frac{\overline{\Gamma_1^n} + \overline{\Gamma_1^{n+1,\star}}}{2},
\quad
\rho_0^{\nph,\star} = \frac{\rho_0^{n} + \rho_0^{n+1,\star}}{2},
\quad
p_0^{\nph,\star} = \frac{p_0^{n} + p_0^{n+1,\star}}{2},\]</div>
<p>with</p>
<div class="math notranslate nohighlight">
\[\overline{\Gamma_1^{n+1,\star}} = {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{n+1,\star}, p_0^{n+1,\star}, X_k^{n+1,\star}\right) \right].\]</div>
<div class="line-block">
<div class="line">For planar geometry, call</div>
<div class="line"><strong>Compute</strong> <span class="math notranslate nohighlight">\(w_0\)</span> <strong>Planar</strong><span class="math notranslate nohighlight">\([\overline{S^{\nph,\star}},\overline{\Gamma_1^{\nph,\star}},p_0^{\nph,\star},\psi^{\nph,\star}]\rightarrow [w_0^{\nph}]\)</span>.</div>
</div>
<div class="line-block">
<div class="line">For spherical geometry, call</div>
<div class="line"><strong>Compute</strong> <span class="math notranslate nohighlight">\(w_0\)</span> <strong>Spherical</strong><span class="math notranslate nohighlight">\([\overline{S^{\nph,\star}},\overline{\Gamma_1^{\nph,\star}},\rho_0^{\nph,\star},p_0^{\nph,\star},\etarho^{\nph,\star}]\rightarrow [w_0^{\nph}]\)</span>.</div>
</div>
<p>Compute the base state velocity forcing. Rearrange equation (<a class="reference external" href="#eq:pizero">[eq:pizero]</a>),</p>
<div class="math notranslate nohighlight">
\[\left ( \frac{\beta_0}{\rho_0} \frac{\partial (\pi_0/\beta_0)}{\partial r} \right )^n =
-\frac{w_0^{\nph} - w_0^\nmh}{\myhalf(\dt^n+\dt^{n-1})}
- w_0^n \left(\frac{\partial w_0}{\partial r}\right)^n,\]</div>
<p>where <span class="math notranslate nohighlight">\(w_0^{n}\)</span> and <span class="math notranslate nohighlight">\((\partial w_0 / \partial r)^{n}\)</span> are defined as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
w_0^n &amp;=&amp; \frac{\dt^{n} w_0^{\nmh} + \dt^{n-1} w_0^{\nph}}{\dt^n+\dt^{n-1}}, \\
\left(\frac{\partial w_0}{\partial r}\right)^{n} &amp;=&amp; \frac{1}{\dt^n+\dt^{n-1} } \left [ \dt^{n} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nmh} + \dt^{n-1} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nph} \right ].\nonumber \\\end{aligned}\end{split}\]</div>
<p>If <span class="math notranslate nohighlight">\(n=0\)</span>, we use <span class="math notranslate nohighlight">\(\dt^{-1} = \dt^0\)</span>.</p>
<p><em>Construct the time-centered advective velocity on edges, :math:`uadvtwo`.</em></p>
<p>The procedure to construct <span class="math notranslate nohighlight">\(\uadvtwodag\)</span> is identical to the procedure
for computing <span class="math notranslate nohighlight">\(\uadvonedag\)</span> in <strong>Step 3</strong>, but uses
the updated values <span class="math notranslate nohighlight">\(w_0^{\nph}\)</span> and <span class="math notranslate nohighlight">\(\pi_0^n\)</span> rather than <span class="math notranslate nohighlight">\(w_0^{\nph,\star}\)</span>
and <span class="math notranslate nohighlight">\(\pi_0^{n,\star}\)</span>. We note that <span class="math notranslate nohighlight">\(\uadvtwo\)</span> satisfies the discrete version of
<span class="math notranslate nohighlight">\(\overline{(\uadvtwo\cdot\eb_r)}=0\)</span> as well as</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left(\beta_0^{\nph,\star} \uadvtwo\right) =
\beta_0^{\nph,\star}\left(S^{\nph,\star} - \overline{S^{\nph,\star}}\right),\]</div>
<div class="math notranslate nohighlight">
\[\beta_0^{\nph,\star} = \frac{ \beta_0^n +  \beta_0^{n+1,\star} }{2};
\qquad
 \beta_0^{n+1,\star} = \beta_0 \left(\rho_0^{n+1,\star}, p_0^{n+1,\star}, \overline{\Gamma_1^{n+1,\star}}\right).\]</div>
<p><em>Advect the base state and full state through a time interval of :math:`dt.`</em></p>
<p>Update <span class="math notranslate nohighlight">\(\rho_0\)</span>, saving the time-centered density at radial edges by calling</p>
<p><strong>Advect Base Density</strong><span class="math notranslate nohighlight">\([\rho_0^{n},w_0^{\nph}] \rightarrow [\rho_0^{(2a)}, \rho_0^{\nph,\pred}]\)</span>.</p>
<p>Update <span class="math notranslate nohighlight">\((\rho X_k)\)</span>. This step is identical to <strong>Step 4B</strong> except we use
the updated values <span class="math notranslate nohighlight">\(w_0^{\nph}, \uadvtwo\)</span>, and <span class="math notranslate nohighlight">\(\rho_0^{(2a)}\)</span> rather than
<span class="math notranslate nohighlight">\(w_0^{\nph,\star}, \uadvone\)</span>, and <span class="math notranslate nohighlight">\(\rho_0^{(2a),\star}\)</span>. In particular:</p>
<ol class="arabic">
<li><p class="first">Compute the time-centered species edge states, <span class="math notranslate nohighlight">\((\rho X_k)^{\nph,\pred}\)</span>,
for the conservative update of <span class="math notranslate nohighlight">\((\rho X_k)^{(1)}\)</span>. We use equations
(<a class="reference external" href="#eq:PerturbationalDensity">[eq:Perturbational Density]</a>) and (<a class="reference external" href="#eq:PrimitiveSpecies">[eq:Primitive Species]</a>) to
predict <span class="math notranslate nohighlight">\(\rho^{'(1)} = \rho^{(1)} - \rho_0^n\)</span> and
<span class="math notranslate nohighlight">\(X_k^{(1)} = (\rho  X_k)^{(1)} / \rho^{(1)}\)</span> to time-centered edges
with <span class="math notranslate nohighlight">\(\Ub = \uadvtwo+w_0^{\nph} \eb_r\)</span>,
yielding <span class="math notranslate nohighlight">\(\rho^{'\nph,\pred}\)</span> and <span class="math notranslate nohighlight">\(X_k^{\nph,\pred}\)</span>.
We convert the perturbational density to a full state density using</p>
<div class="math notranslate nohighlight">
\[\rho^{\nph,\pred} = \rho^{'\nph,\pred} + \frac{\rho_0^n + \rho_0^{(2a)}}{2}.\]</div>
<p>Then, <span class="math notranslate nohighlight">\((\rho X_k)^{\nph,\pred} = \rho^{\nph,\pred} \, X_k^{\nph,\pred}\)</span>.</p>
</li>
<li><p class="first">Evolve <span class="math notranslate nohighlight">\((\rho X_k)^{(1)} \rightarrow (\rho X_k)^{(2)}\)</span> using</p>
<div class="math notranslate nohighlight">
\[(\rho X_k)^{(2)} = (\rho X_k)^{(1)}
- \dt \left\{ \nabla \cdot \left[\left(\uadvtwo+w_0^{\nph} \eb_r\right)
(\rho X_k)^{\nph,\pred} \right] \right\},\]</div>
<div class="math notranslate nohighlight">
\[\rho^{(2)} = \sum_k (\rho X_k)^{(2)},
\qquad
X_k^{(2)} = (\rho X_k)^{(2)} / \rho^{(2)}.\]</div>
</li>
</ol>
<p>Define a radial edge-centered <span class="math notranslate nohighlight">\(\etarho^{\nph}\)</span>.</p>
<p>For planar geometry,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
 \etarho^{\nph} &amp;=&amp; {\rm {\bf Avg}} \sum_k \left [\left(\uadvtwo \cdot \eb_r + w_0^{\nph}\right) (\rho X_k)^{\nph,\pred} \right] \nonumber \\
&amp;&amp;- w_0^{\nph} \rho_0^{\nph,\pred},\end{aligned}\end{split}\]</div>
<p>For spherical geometry, first construct
<span class="math notranslate nohighlight">\(\etarho^{{\rm cart},\nph} = [\rho'(\Ub\cdot\eb_r)]^{\nph}\)</span> on Cartesian
cell centers using:</p>
<div class="math notranslate nohighlight">
\[\etarho^{{\rm cart},\nph} = \left[\left(\frac{\rho^{(1)}+\rho^{(2)}}{2}\right)-\left(\frac{\rho_0^n+\rho_0^{(2a)}}{2}\right)\right] \left(\uadvtwo \cdot \eb_r + w_0^{\nph}\right).\]</div>
<p>Then,</p>
<div class="math notranslate nohighlight">
\[\etarho^{\nph} = {\rm {\bf Avg}}\left(\etarho^{{\rm cart},\nph}\right).\]</div>
<p>This gives a radial cell-centered <span class="math notranslate nohighlight">\(\etarho^{\nph}\)</span>. To get
<span class="math notranslate nohighlight">\(\etarho^{\nph}\)</span> at radial edges, average the two neighboring
cell-centered values.</p>
<p>Correct <span class="math notranslate nohighlight">\(\rho_0\)</span> by setting <span class="math notranslate nohighlight">\(\rho_0^{n+1} =\)</span> <strong>Avg</strong><span class="math notranslate nohighlight">\((\rho^{(2)})\)</span>.</p>
<p>Update <span class="math notranslate nohighlight">\(p_0\)</span> by calling
<strong>Enforce HSE</strong><span class="math notranslate nohighlight">\([p_0^n,\rho_0^{n+1}] \rightarrow [p_0^{n+1}]\)</span>.</p>
<p>Compute <span class="math notranslate nohighlight">\(\psi^{\nph}\)</span>.</p>
<p>For planar geometry,</p>
<div class="math notranslate nohighlight">
\[\psi_j^{\nph} = \frac{1}{2} \left(\eta_{\rho,j-\myhalf}^{\nph}
+ \eta_{\rho,j+\myhalf}^{\nph}\right) g.\]</div>
<p>For spherical geometry, first compute:</p>
<div class="math notranslate nohighlight">
\[\overline{\Gamma_1^{(2)}} = {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{(2)}, p_0^{n+1},
X_k^{(2)}\right) \right].\]</div>
<p>Then, define <span class="math notranslate nohighlight">\(\psi^{\nph}\)</span> using equation (<a class="reference external" href="#eq:psidef">[eq:psi def]</a>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\psi_j^{\nph}
&amp;=&amp; \left(\frac{\overline{\Gamma_1^{(1)}}+\overline{\Gamma_1^{(2)}}}{2}\right)_j \left(\frac{p_0^n+p_0^{n+1}}{2}\right)_j \nonumber \\
&amp;&amp; \left \{ \overline{S_j^{\nph}} - \frac{1}{r_j^2} \left [ \left(r^2 w_0^{\nph}\right)_{j+\myhalf} - \left(r^2 w_0^{\nph}\right)_{j-\myhalf} \right ] \right \}.\end{aligned}\end{split}\]</div>
<p>Update <span class="math notranslate nohighlight">\((\rho h)_0\)</span> by calling
<strong>Advect Base Enthalpy</strong><span class="math notranslate nohighlight">\([(\rho h)_0^n, w_0^{\nph}, \psi^{\nph}] \rightarrow [(\rho h)_0^{n+1}]\)</span>.</p>
<div class="line-block">
<div class="line">Update the enthalpy. This step is identical to <strong>Step 4H</strong> except we use
the updated values <span class="math notranslate nohighlight">\(w_0^{\nph}, \uadvtwo, \rho_0^{n+1}, (\rho h)_0^{n+1}, p_0^{n+\myhalf}\)</span>,
and <span class="math notranslate nohighlight">\(\psi^{n+\myhalf}\)</span> rather than</div>
<div class="line"><span class="math notranslate nohighlight">\(w_0^{\nph,\star}, \uadvone, \rho_0^{n+1,\star}, (\rho h)_0^{n+1,\star}, p_0^n\)</span>,
and <span class="math notranslate nohighlight">\(\psi^{n+\myhalf,\star}\)</span>. In particular:</div>
</div>
<p>Compute the time-centered enthalpy edge state, <span class="math notranslate nohighlight">\((\rho h)^{\nph,\pred},\)</span>
for the conservative update of <span class="math notranslate nohighlight">\((\rho h)^{(1)}\)</span>. We use equation
(<a class="reference external" href="#eq:PerturbationalEnthalpy">[eq:Perturbational Enthalpy]</a>) to predict
<span class="math notranslate nohighlight">\((\rho h)' = (\rho h)^{(1)} - (\rho h)_0^n\)</span> to time-centered edges
with <span class="math notranslate nohighlight">\(\Ub = \uadvtwo+w_0^{\nph} \eb_r\)</span>,
yielding <span class="math notranslate nohighlight">\((\rho h)^{'\nph,\pred}\)</span>.
We convert the perturbational enthalpy to a full state enthalpy using</p>
<div class="math notranslate nohighlight">
\[(\rho h)^{\nph,\pred} = (\rho h)^{'\nph,\pred} + \frac{(\rho h)_0^n + (\rho h)_0^{n+1}}{2}.\]</div>
<p>Evolve <span class="math notranslate nohighlight">\((\rho h)^{(1)} \rightarrow (\rho h)^{(2)}\)</span>.</p>
<p>For planar geometry,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho h)^{(2)}
&amp;=&amp; (\rho h)^{(1)} - \dt \left\{ \nabla \cdot \left[ \left(\uadvtwo+w_0^{\nph} \eb_r\right)  (\rho h)^{\nph,\pred} \right] \right\} \nonumber \\
&amp;&amp; + \dt \left(\uadvtwo \cdot \eb_r\right) \left(\frac{\partial p_0}{\partial r} \right)^\nph + \dt \psi^{\nph},\end{aligned}\end{split}\]</div>
<p>For spherical geometry,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho h)^{(2)}
&amp;=&amp; (\rho h)^{(1)} - \dt \left\{ \nabla \cdot \left[ \left(\uadvtwo+w_0^{\nph} \eb_r\right)  (\rho h)^{\nph,\pred} \right] \right\} \nonumber \\
&amp;&amp; + \dt \left[ \nabla \cdot \left (\uadvtwo p_0^{\nph} \right ) - p_0^{\nph} \nabla \cdot \uadvtwo \right] + \dt \psi^{\nph},\nonumber \\\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(p_0^\nph\)</span> is defined as <span class="math notranslate nohighlight">\(p_0^\nph = (p_0^n+p_0^{n+1})/2\)</span>.</p>
<p>Then, for each Cartesian cell where <span class="math notranslate nohighlight">\(\rho^{(2)} &lt; \rho_\mathrm{cutoff}\)</span>, we recompute enthalpy using</p>
<div class="math notranslate nohighlight">
\[(\rho h)^{(2)} = \rho^{(2)}h\left(\rho^{(2)},p_0^{n+1},X_k^{(2)}\right).\]</div>
<p>Update the temperature using the equation of state:
:math:<a href="#id33"><span class="problematic" id="id34">`</span></a>T^{(2)} =</p>
<blockquote>
<div>T(rho^{(2)}, h^{(2)}, X_k^{(2)})` (planar geometry) or</div></blockquote>
<dl class="docutils">
<dt>:math:<a href="#id35"><span class="problematic" id="id36">`</span></a>T^{(2)} =</dt>
<dd>T(rho^{(2)}, p_0^{n+1}, X_k^{(2)})` (spherical geometry).</dd>
</dl>
<p>Again, the actual inputs depend of use_tfromp.</p>
<p><em>React the full state through a second time interval of :math:`dt / 2.`</em></p>
<div class="line-block">
<div class="line">Call <strong>React State</strong><span class="math notranslate nohighlight">\([\rho^{(2)},(\rho h)^{(2)}, X_k^{(2)},T^{(2)}, (\rho\Hext)^{(2)}, p_0^{n+1}]\)</span></div>
<div class="line"><span class="math notranslate nohighlight">\(\rightarrow [\rho^{n+1}, (\rho h)^{n+1}, X_k^{n+1}, T^{n+1}, (\rho \omegadot_k)^{(2)}, (\rho \Hnuc)^{(2)} ].\)</span></div>
</div>
<p><em>Define the new time expansion, :math:`S^{n+1}`, and :math:`overline{Gamma_1^{n+1}}`.</em></p>
<ol class="arabic">
<li><p class="first">Define</p>
<div class="math notranslate nohighlight">
\[S^{n+1} =  -\sigma  \sum_k  \xi_k (\omegadot_k)^{(2)}  + \sigma \Hnuc^{(2)} +
  \frac{1}{\rho^{n+1} p_\rho} \sum_k p_{X_k}  ({\omegadot}_k)^{(2)}
   + \sigma \Hext^{(2)},\]</div>
<p>where <span class="math notranslate nohighlight">\((\omegadot_k)^{(2)} = (\rho \omegadot_k)^{(2)} / \rho^{(2)}\)</span>
and the thermodynamic quantities are defined using <span class="math notranslate nohighlight">\(\rho^{n+1}\)</span>,
<span class="math notranslate nohighlight">\(X_k^{n+1}\)</span>, and <span class="math notranslate nohighlight">\(T^{n+1}\)</span> as inputs to the equation of state.
If we are doing thermal diffusion (use_thermal_diffusion= T)
then we also include the diffusive term in <span class="math notranslate nohighlight">\(S\)</span>.
Then, compute</p>
<div class="math notranslate nohighlight">
\[\overline{S^{n+1}} = {\mathrm{\bf Avg}} (S^{n+1}).\]</div>
</li>
<li><p class="first">Define</p>
<div class="math notranslate nohighlight">
\[\overline{\Gamma_1^{n+1}} = {\rm{\bf Avg}}\left[\Gamma_1\left(\rho^{n+1}, p_0^{n+1},
X_k^{n+1}\right) \right].\]</div>
</li>
</ol>
<p><em>Update the velocity</em>.</p>
<p>First, we compute the time-centered edge velocities, <span class="math notranslate nohighlight">\(\Ubt^{\nph,\pred}\)</span>.
Then, we define</p>
<div class="math notranslate nohighlight">
\[\rho^\nph = \frac{\rho^n + \rho^{n+1}}{2}, \qquad \rho_0^\nph = \frac{\rho_0^n + \rho_0^{n+1}}{2}.\]</div>
<p>We update the velocity field <span class="math notranslate nohighlight">\(\Ubt^n\)</span> to <span class="math notranslate nohighlight">\(\Ubt^{n+1,\dagger}\)</span> by discretizing
equation (<a class="reference external" href="#eq:flow:utildeupd">[eq:flow:utildeupd]</a>) as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\Ubt^{n+1,\dagger}
&amp;=&amp; \Ubt^n - \dt \left[\left(\uadvtwo+ w_0^{\nph} \eb_r\right) \cdot \nabla \Ubt^{\nph,\pred} \right] \nonumber \\
&amp;&amp;- \dt \left(\uadvtwo \cdot \eb_r\right)  \left(\frac{\partial w_0}{\partial r} \right)^\nph \eb_r \nonumber \\
&amp;&amp; + \dt \left[ - \frac{\beta_0^\nph}{\rho^\nph} \mathbf{G} \left ( \frac{\pi}{\beta_0}\right)^\nmh + \left(\frac{\beta_0}{\rho_0}\frac{\partial(\pi_0/\beta_0)}{\partial r}\right)^n \eb_r - \frac{\left(\rho^\nph-\rho_0^\nph\right)}{\rho^\nph} g^{\nph} \eb_r \right],\nonumber \\\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{G}\)</span> approximates a cell-centered gradient from nodal
data. Again, the <span class="math notranslate nohighlight">\(\dagger\)</span> superscript refers
to the fact that the updated velocity does not satisfy the divergence
constraint.</p>
<p>Finally, we use an approximate nodal projection to define <span class="math notranslate nohighlight">\(\Ubt^{n+1}\)</span>
from <span class="math notranslate nohighlight">\(\Ubt^{n+1,\dagger},\)</span> such that <span class="math notranslate nohighlight">\(\Ubt^{n+1}\)</span> approximately
satisfies</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left(\beta_0^{\nph} \Ubt^{n+1} \right)
= \beta_0^{\nph} \left(S^{n+1} - \overline{S^{n+1}} \right),\]</div>
<p>where <span class="math notranslate nohighlight">\(\beta_0^{\nph}\)</span> is defined as</p>
<div class="math notranslate nohighlight">
\[\beta_0^{\nph} = \frac{\beta_0^n + \beta_0^{n+1}}{2}; \qquad
\beta_0^{n+1} = \beta \left(\rho_0^{n+1}, p_0^{n+1}, \overline{\Gamma_1^{n+1}}, g^{n+1}\right).\]</div>
<p>As part of the projection we also define the new-time perturbational pressure,
<span class="math notranslate nohighlight">\(\pi^\nph.\)</span> This projection necessarily differs from the MAC projection used in
<strong>Step 3</strong> and <strong>Step 7</strong> because the velocities in those steps are defined
on edges and <span class="math notranslate nohighlight">\(\Ubt^{n+1}\)</span> is defined at cell centers, requiring different divergence
and gradient operators. Details of the approximate projection are given in Paper III.</p>
<p><em>Compute a new :math:`dt.`</em></p>
<p>Compute <span class="math notranslate nohighlight">\(\dt\)</span> for the next time step with the procedure described in
§3.4 of Paper III using <span class="math notranslate nohighlight">\(w_0\)</span> as computed in <strong>Step 6</strong> and <span class="math notranslate nohighlight">\(\Ubt^{n+1}\)</span>
as computed in <strong>Step 11</strong>.</p>
<p>This completes one step of the algorithm.</p>
</div>
<div class="section" id="volume-discrepancy-changes">
<h3>Volume Discrepancy Changes<a class="headerlink" href="#volume-discrepancy-changes" title="Permalink to this headline">¶</a></h3>
<p>Chapter&nbsp;<a class="reference external" href="#ch:volume">[ch:volume]</a> describes the reasoning behind the volume discrepancy
term—a forcing term added to the constraint equation to bring us back to
the equation of state. This addition of this term (enabled with dpdt_factor= T) modifies our
equation set in the following way:</p>
<ul>
<li><p class="first">In <strong>Step 2B</strong>, to compute <span class="math notranslate nohighlight">\(w_0\)</span>, we need to account for the volume discrepancy
term by first defining <span class="math notranslate nohighlight">\(p_{\rm EOS}^n = \overline{p(\rho,h,X_k)^n}\)</span>, and then using:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial w_0^{\nph,\star}}{\partial r} = \overline{S^{\nph,\star\star}} - \frac{1}{\overline{\Gamma_1^n}p_0^n}\psi^{\nmh} - \underbrace{\frac{f}{\overline{\Gamma_1^n}p_0^n}\left(\frac{p_0^n-\overline{p_{\rm EOS}^n}}{\Delta t}\right)}_{\delta\chi_{w_0}}.\]</div>
</li>
<li><p class="first">In <strong>Step 3</strong>, the MAC projection should account for the volume discrepancy term:</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left(\beta_0^n \uadvone\right) =
\beta_0^n \left[ \left(S^{\nph,\star\star} - \overline{S^{\nph,\star\star}}\right)
+ \underbrace{\frac{f}{\gammabar^n p_0^n}
\left(\frac{p_{\rm EOS}^n - \overline{p_{\rm EOS}^n}}{\Delta t^n}\right)}_{\delta\chi}\right].\]</div>
</li>
<li><p class="first">In <strong>Step 6B</strong>, to compute <span class="math notranslate nohighlight">\(w_0\)</span>, we need to account for the volume discrepancy
term by first defining <span class="math notranslate nohighlight">\(p_{\rm EOS}^{n+1,\star} = p(\rho,h,X_k)^{n+1,\star}\)</span>,
<span class="math notranslate nohighlight">\(\overline{\Gamma_1^{\nph,\star}} = (\overline{\Gamma_1^{n}}+\overline{\Gamma_1^{n+1,\star}})/2\)</span>,
and <span class="math notranslate nohighlight">\(p^{\nph,\star} = (p^{n}+p^{n+1,\star})/2\)</span>, and then using:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial w_0^{\nph}}{\partial r} = \overline{S^{\nph,\star}} - \frac{1}{\overline{\Gamma_1^{\nph,\star}}p_0^{\nph,\star}}\psi^{\nph,\star} - \frac{f}{\overline{\Gamma_1^{n+1,\star}}p_0^{n+1,\star}}\left(\frac{p_0^{n+1,\star}-\overline{p_{\rm EOS}^{n+1,\star}}}{\Delta t}\right) - \delta\chi_{w_0}\]</div>
</li>
<li><p class="first">In <strong>Step 7</strong>, the MAC projection should account for the volume discrepancy term:</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left(\beta_0^{\nph,\star} \uadvtwo\right) = \beta_0^{\nph,\star}\left[\left(S^{\nph,\star} - \overline{S^{\nph,\star}}\right) + \frac{f}{\overline{\Gamma_1^{n+1,\star}} p_0^{n+1,\star}} \left(\frac{p_{\rm EOS}^{n+1,\star} - \overline{p_{\rm EOS}^{n+1,\star}}}{\Delta t^n}\right) + \delta\chi\right],\]</div>
<p>where <span class="math notranslate nohighlight">\(p(\rho,h,X_k)^{\nph,\star} = \left[p(\rho,h,X_k)^n +p(\rho,h,X_k)^{n+1,\star}\right]/2\)</span>.</p>
</li>
<li><p class="first">In <strong>Step 11</strong>, the approximate projection should account for the volume
discrepancy term:</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left(\beta_0^{\nph} \Ubt^{n+1} \right)  = \beta_0^{\nph}\left\{  \left(S^{n+1} - \overline{S^{n+1}} \right)
+ \frac{f}{\overline{\Gamma_1^{n+1}} p_0^{n+1}}
\left[\frac{p(\rho,h,X_k)^{n+1} - \overline{p(\rho,h,X_k)^{n+1}}}{\Delta t^n}\right]\right\}.\]</div>
</li>
</ul>
</div>
<div class="section" id="sec-flow-gamma1vary-gamma-1-variation-changes">
<h3>[sec:flow:gamma1vary] <span class="math notranslate nohighlight">\(\Gamma_1\)</span> Variation Changes<a class="headerlink" href="#sec-flow-gamma1vary-gamma-1-variation-changes" title="Permalink to this headline">¶</a></h3>
<p>The constraint we derive from requiring the pressure to be close to
the background hydrostatic pressure takes the form:</p>
<div class="math notranslate nohighlight">
\[\nablab \cdotb \Ub + \frac{1}{\Gamma_1 p_0} \frac{Dp_0}{Dt} = S \enskip .\]</div>
<p>The default MAESTROeX&nbsp;algorithm replaces <span class="math notranslate nohighlight">\(\Gamma_1\)</span> with <span class="math notranslate nohighlight">\(\gammabar\)</span>,
allowing us to write this as a divergence constraint. In paper&nbsp;III,
we explored the effects of localized variations in <span class="math notranslate nohighlight">\(\Gamma_1\)</span> by
writing <span class="math notranslate nohighlight">\(\Gamma_1 = \gammabar + \delta \Gamma_1\)</span>. This gives us:</p>
<div class="math notranslate nohighlight">
\[\nablab \cdotb \Ub + \frac{1}{(\gammabar + \delta \Gamma_1) \; p_0}
  \Ub \cdotb \nablab p_0 = S - \frac{1}{(\gammabar + \delta \Gamma_1) \; p_0}
  \frac{\partial p_0}{\partial t} \enskip .\]</div>
<p>Assuming that <span class="math notranslate nohighlight">\(\delta \Gamma_1 \ll \gammabar\)</span>, we then
have</p>
<div class="math notranslate nohighlight">
\[\begin{split}\nablab \cdotb \Ub + \frac{1}{\gammabar p_0} \Ub \cdotb \nablab p_0
 \left [ 1 - \frac{\delta\Gamma_1}{\gammabar} + \frac{(\delta\Gamma_1)^2}{\gammabar^2} \right ]
= S - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t}
 \left [ 1 - \frac{\delta\Gamma_1}{\gammabar} + \frac{(\delta\Gamma_1)^2}{\gammabar^2} \right ] \\\end{split}\]</div>
<p>Grouping by order of the correction, we have</p>
<div class="math notranslate nohighlight">
\[\nablab \cdotb \Ub + \frac{1}{\gammabar p_0} \Ub \cdotb \nablab p_0
= S - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} +
\underbrace{\frac{\delta \Gamma_1}{\gammabar^2 p_0}
            \left [\frac{\partial p_0}{\partial t} + \Ub \cdotb \nablab p_0\right ]}_{\mbox{first order corrections}}
 -
  \underbrace{\frac{(\delta\Gamma_1)^2}{\gammabar^3 p_0}
            \left [ \frac{\partial p_0}{\partial t} + \Ub \cdotb \nablab p_0 \right ]}_{\mbox{second order corrections}} \enskip , \label{eq:gammafull}\]</div>
<div class="section" id="keeping-to-first-order-in-delta-gamma-1">
<h4>Keeping to First Order in <span class="math notranslate nohighlight">\(\delta\Gamma_1\)</span><a class="headerlink" href="#keeping-to-first-order-in-delta-gamma-1" title="Permalink to this headline">¶</a></h4>
<p>The base state evolution equation is the average of Eq.&nbsp;<a class="reference external" href="#eq:gammafull">[eq:gammafull]</a> over a layer</p>
<div class="math notranslate nohighlight">
\[\nablab \cdot w_0 \er + \frac{1}{\gammabar p_0} w_0 \er \cdotb \nablab p_0 =
\Sbar - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} + \overline{
  \left ( \frac{\delta \Gamma_1}{\gammabar^2 p_0} \Ubt \cdotb \nablab p_0
  \right ) } \enskip .\]</div>
<p>where we see that the <span class="math notranslate nohighlight">\([\delta \Gamma_1/(\Gamma_1^2 p_0)] \partial p_0/\partial t\)</span> terms averages to zero, since the average of <span class="math notranslate nohighlight">\(\delta\Gamma_1\)</span> term is zero.
Subtracting this from equation (<a class="reference external" href="#eq:gammafull">[eq:gammafull]</a>), we have</p>
<div class="math notranslate nohighlight">
\[\nablab \cdotb \Ubt + \frac{1}{\gammabar p_0} \Ubt \cdotb \nablab p_0 = S -
\Sbar + \frac{\delta \Gamma_1}{\gammabar^2 p_0} \left (\psi + \Ubt \cdotb
\nablab p_0 \right ) - \overline{ \left ( \frac{\delta \Gamma_1}{\gammabar^2 p_0} \Ubt
\cdotb \nablab p_0 \right ) } \enskip .\]</div>
<p>These can be written more compactly as:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial w_0}{\partial r} = \Sbar -\frac{1}{\gammabar p_0}\psi +
\overline{ \left ( \frac{\delta \Gamma_1}{\gammabar^2 p_0} \Ubt \cdotb \nablab
  p_0 \right ) } \enskip , \label{eq:base_w0_with_dgamma1}\]</div>
<p>for plane-parallel geometries (analogous to
Eq.&nbsp;<a class="reference external" href="#eq:flow:dw0dr_planar">[eq:flow:dw0dr_planar]</a>), and</p>
<div class="math notranslate nohighlight">
\[\nablab \cdotb (\beta_0 \Ubt) = \beta_0 \left [ S - \Sbar + \frac{\delta
    \Gamma_1}{\gammabar^2 p_0} \psi + \frac{\delta \Gamma_1}{\gammabar^2 p_0}
  \Ubt \cdotb \nablab p_0 - \overline{ \left ( \frac{\delta
      \Gamma_1}{\gammabar^2 p_0} \Ubt \cdotb \nablab p_0 \right ) } ~ \right ]
 \enskip ,  \label{eq:constraint_with_delta_gamma}\]</div>
<p>This constraint is not in a form that can be projected. To solve this
form, we need to use a lagged <span class="math notranslate nohighlight">\(\Ubt\)</span> in the righthand side.</p>
<p>This change comes into MAESTROeX&nbsp;in a variety of steps, summarized here.
To enable this portion of the algorithm, set use_delta_gamma1_term = T.</p>
<ul>
<li><p class="first">In <strong>Step 3</strong>, we are doing the “predictor” portion of the
MAESTROeX&nbsp;algorithm, getting the MAC velocity that satisfies the constraint,
so we do not try to incorporate the <span class="math notranslate nohighlight">\(\delta \Gamma_1\)</span> effect. We set
all the <span class="math notranslate nohighlight">\(\delta \Gamma_1\)</span> terms in
Eq.&nbsp;<a class="reference external" href="#eq:constraint_with_delta_gamma">[eq:constraint_with_delta_gamma]</a> to zero.</p>
</li>
<li><p class="first">In <strong>Step 6</strong>, we are computing the new time-centered source,
<span class="math notranslate nohighlight">\(S^{\nph,\star}\)</span> and the base state velocity, <span class="math notranslate nohighlight">\(w_0^\nph\)</span>. Now we can
incorporate the <span class="math notranslate nohighlight">\(\delta \Gamma_1\)</span> effect. First we construct:</p>
<div class="math notranslate nohighlight">
\[\frac{\delta \Gamma_1}{\Gamma_1^2 p_0} \Ubt \cdotb \nablab p_0 \approx
   \frac{\Gamma_1^{n+1,\star} - \overline{\Gamma_1^{n+1,\star}}}
         {{\overline{\Gamma_1^{n+1,\star}}}^2} \frac{1}{p_0^n} \Ubt^n \cdotb \nablab p_0^n\]</div>
<p>Then we call <strong>average</strong> to construct the lateral average of this</p>
<div class="math notranslate nohighlight">
\[\overline{\frac{\delta \Gamma_1}{\Gamma_1^2 p_0} \Ubt \cdotb \nablab p_0} =
   \mathbf{Avg} \left (\frac{\Gamma_1^{n+1,\star} - \overline{\Gamma_1^{n+1,\star}}}
         {{\overline{\Gamma_1^{n+1,\star}}}^2} \frac{1}{p_0^n} \Ubt^n \cdotb \nablab p_0^n \right )\]</div>
<p>Since the average of this is needed in advancing <span class="math notranslate nohighlight">\(w_0\)</span>, we modify <span class="math notranslate nohighlight">\(\overline{S}\)</span>
to include this average:</p>
<div class="math notranslate nohighlight">
\[\overline{S^{\nph,\star}} \leftarrow \overline{S^{\nph,\star}} +
   \overline{\frac{\delta \Gamma_1}{\Gamma_1^2 p_0} \Ubt \cdotb \nablab p_0}\]</div>
</li>
<li><p class="first">In <strong>Step 7</strong>, we now include the <span class="math notranslate nohighlight">\(\delta \Gamma_1\)</span> term in the righthand
side for the constraint by solving:</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left(\beta_0^{\nph,\star} \uadvtwo\right) =
\beta_0^{\nph,\star}\left( S^{\nph,\star} - \overline{S^{\nph,\star}} +
   \frac{\Gamma_1^{n+1,\star} - \overline{\Gamma_1^{n+1,\star}}}
         {{\overline{\Gamma_1^{n+1,\star}}}^2} \frac{1}{p_0^n}
         (\psi^{\nph,\star} + \Ubt^n \cdotb \nablab p_0^n)
\right)\]</div>
<p>We note that this includes the average of the correction term as shown
in Eq.&nbsp;<a class="reference external" href="#eq:constraint_with_delta_gamma">[eq:constraint_with_delta_gamma]</a> because we modified
<span class="math notranslate nohighlight">\(\bar{S}\)</span> to include this already.</p>
</li>
<li><p class="first">In <strong>Step 10</strong>, we do a construction much like that done in <strong>Step 6</strong>,
but with the time-centerings of some of the quantities changed.
First we construct:</p>
<div class="math notranslate nohighlight">
\[\frac{\delta \Gamma_1}{\Gamma_1^2 p_0} \Ubt \cdotb \nablab p_0 \approx
   \frac{\Gamma_1^{n+1} - \overline{\Gamma_1^{n+1}}}
         {{\overline{\Gamma_1^{n+1}}}^2} \frac{1}{p_0^{n+1}} \Ubt^n \cdotb \nablab p_0^{n+1}\]</div>
<p>Then we call <strong>average</strong> to construct the lateral average of this</p>
<div class="math notranslate nohighlight">
\[\overline{\frac{\delta \Gamma_1}{\Gamma_1^2 p_0} \Ubt \cdotb \nablab p_0} =
   \mathbf{Avg} \left (\frac{\Gamma_1^{n+1} - \overline{\Gamma_1^{n+1}}}
         {{\overline{\Gamma_1^{n+1}}}^2} \frac{1}{p_0^{n+1}} \Ubt^n \cdotb \nablab p_0^{n+1} \right )\]</div>
<p>Again we modify <span class="math notranslate nohighlight">\(\overline{S}\)</span> to include this average:</p>
<div class="math notranslate nohighlight">
\[\overline{S^{n+1}} \leftarrow \overline{S^{n+1}} +
   \overline{\frac{\delta \Gamma_1}{\Gamma_1^2 p_0} \Ubt \cdotb \nablab p_0}\]</div>
</li>
<li><p class="first">In <strong>Step 11</strong>, we modify the source of the constraint to include the
<span class="math notranslate nohighlight">\(\delta \Gamma_1\)</span> information. In particular, we solve:</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left(\beta_0^{\nph} \Ubt^{n+1} \right)
= \beta_0^{\nph} \left(S^{n+1} - \overline{S^{n+1}} +
   \frac{\Gamma_1^{n+1} - \overline{\Gamma_1^{n+1}}}
         {{\overline{\Gamma_1^{n+1}}}^2} \frac{1}{p_0^{n+1}}
         (\psi^{\nph} + \Ubt^n \cdotb \nablab p_0^{n+1})
\right)\]</div>
</li>
</ul>
</div>
</div>
<div class="section" id="thermal-diffusion-changes">
<span id="sec-flow-diffusion"></span><h3>Thermal Diffusion Changes<a class="headerlink" href="#thermal-diffusion-changes" title="Permalink to this headline">¶</a></h3>
<p>Thermal diffusion was introduced in the XRB paper&nbsp;<a href="#id37"><span class="problematic" id="id38">:raw-latex:`\cite{xrb}`</span></a>. This
introduces a new term to <span class="math notranslate nohighlight">\(S\)</span> as well as the enthalpy equation.
Treating the enthalpy equation now requires a parabolic solve. We describe
that process here.</p>
<p>Immediately after <strong>Step 4H</strong>, diffuse the enthalpy through
a time interval of <span class="math notranslate nohighlight">\(\dt\)</span>. First, define <span class="math notranslate nohighlight">\((\rho h)^{(1a),\star} = (\rho h)^{(2),\star}\)</span>.
We recompute <span class="math notranslate nohighlight">\((\rho h)^{(2),\star}\)</span> to account for thermal diffusion. Here we begin
with the enthalpy equation, but consider only the
diffusion terms,</p>
<div class="math notranslate nohighlight">
\[\frac{\partial (\rho h)}{\partial t} = \nabla\cdot\kth\nabla T.\]</div>
<p>We can recast this as an enthalpy-diffusion equation by applying the
chain-rule to <span class="math notranslate nohighlight">\(h(p_0,T,X_k)\)</span>,</p>
<div class="math notranslate nohighlight">
\[\nabla h = h_p \nabla p_0 + c_p \nabla T + \sum_k \xi_k \nabla X_k \enskip ,\]</div>
<p>giving</p>
<div class="math notranslate nohighlight">
\[\frac{\partial (\rho h)}{\partial t}  =
 \nabla\cdot \frac{\kth}{c_p}\nabla h -
 \sum_k \nabla\cdot \frac{\xi_k \kth}{c_p}\nabla X_k -
 \nabla\cdot \frac{h_p \kth}{c_p}\nabla p_0.\]</div>
<p>Compute <span class="math notranslate nohighlight">\(\kth^{(1)}, c_p^{(1)}\)</span>, and <span class="math notranslate nohighlight">\(\xi_k^{(1)}\)</span> from <span class="math notranslate nohighlight">\(\rho^{(1)}, T^{(1)}\)</span>, and <span class="math notranslate nohighlight">\(X_k^{(1)}\)</span> as inputs to the equation of state. The update is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho h)^{(2),\star} &amp;=&amp; (\rho h)^{(1a),\star} + \frac{\dt}{2}\nabla\cdot\left(\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(2),\star} + \frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\right)\nonumber\\
&amp;&amp;- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(2),\star} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&amp;&amp;- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n+1,\star} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),\end{aligned}\end{split}\]</div>
<p>which is numerically implemented as a diffusion equation for <span class="math notranslate nohighlight">\(h^{(2),\star}\)</span>,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\left(\rho^{(2),\star} - \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla\right)h^{(2),\star} &amp;=&amp; (\rho h)^{(1a),\star} + \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\nonumber\\
&amp;&amp;- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(2),\star} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&amp;&amp;- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n+1,\star} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),\end{aligned}\end{split}\]</div>
<p>Immediately after <strong>Step 8H</strong>, diffuse the enthalpy through a time interval of
<span class="math notranslate nohighlight">\(\dt\)</span>. First, define <span class="math notranslate nohighlight">\((\rho h)^{(1a)} = (\rho h)^{(2)}\)</span>. We recompute <span class="math notranslate nohighlight">\((\rho h)^{(2)}\)</span> to
account for thermal diffusion. Compute <span class="math notranslate nohighlight">\(\kth^{(2),\star}, c_p^{(2),\star}\)</span>, and
<span class="math notranslate nohighlight">\(\xi_k^{(2),\star}\)</span>, from <span class="math notranslate nohighlight">\(\rho^{(2),\star}, T^{(2),\star}\)</span>, and <span class="math notranslate nohighlight">\(X_k^{(2),\star}\)</span> as inputs to
the equation of state. The update is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
(\rho h)^{(2)} &amp;=&amp; (\rho h)^{(1a)} + \frac{\dt}{2}\nabla\cdot\left(\frac{\kth^{(2),\star}}{c_p^{(2),\star}}\nabla h^{(2)} + \frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\right)\nonumber\\
&amp;&amp;- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla X_k^{(2)} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&amp;&amp;- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla p_0^{n+1} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),\end{aligned}\end{split}\]</div>
<p>which is numerically implemented as a diffusion equation for <span class="math notranslate nohighlight">\(h^{(2)}\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\left(\rho^{(2)} - \frac{\dt}{2}\nabla\cdot\frac{\kth^{(2),\star}}{c_p^{(2),\star}}\nabla\right)h^{(2)} &amp;=&amp; (\rho h)^{(1a)} + \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\nonumber\\
&amp;&amp;- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla X_k^{(2)} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&amp;&amp;- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla p_0^{n+1} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),\end{aligned}\end{split}\]</div>
</div>
</div>
<div class="section" id="initialization">
<span id="sec-initialization"></span><h2>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<p>[sec:flow:initialization]</p>
<p>We start each calculation with user-specified initial values for
<span class="math notranslate nohighlight">\(\rho\)</span>, <span class="math notranslate nohighlight">\(X_k\)</span> and <span class="math notranslate nohighlight">\(T,\)</span> as well as an initial background state. In
order for the low Mach number assumption to hold, the initial data
must be thermodynamically consistent with the initial background
state. In addition, the initial velocity field must satisfy an
initial approximation to the divergence constraint. We use an iterative
procedure to compute both an initial right-hand-side for the
constraint equation and an initial velocity field that satisfies
the constraint. The user specifies the number of iterations,
<span class="math notranslate nohighlight">\(N_{\rm iters}^{S},\)</span> in this first step of the initialization procedure.</p>
<div class="line-block">
<div class="line">The initial perturbational pressure also needs to be determined for
use in <strong>Steps 3</strong>, <strong>7</strong>, and <strong>11</strong>.
This is done through a second iterative procedure which follows the
time advancement algorithm as described in <strong>Steps 1-11</strong> in
§<a class="reference external" href="#Sec:TimeAdvancementAlgorithm">2</a>.
The user specifies the number of iterations,
<span class="math notranslate nohighlight">\(N_{\rm iters}^{\pi},\)</span> in this second step of the initialization procedure.
The details for both iterations are given below.</div>
</div>
<p>First, we need to construct approximations to <span class="math notranslate nohighlight">\(S^0, w_0^{-\myhalf}, \Delta t^0\)</span>,
and <span class="math notranslate nohighlight">\(\Ub^0\)</span>. Start with initial data <span class="math notranslate nohighlight">\(X_k^{\initp}, \rho^{\initp},\)</span> <span class="math notranslate nohighlight">\(T^{\initp},\)</span>
an initial base state, and an initial guess for the velocity, <span class="math notranslate nohighlight">\(\Ub^{\initp}\)</span>.
Set <span class="math notranslate nohighlight">\(w_0^0 = 0\)</span> as an initial approximation. Use the equation of state to
determine <span class="math notranslate nohighlight">\((\rho h)^{\initp}\)</span>. Compute <span class="math notranslate nohighlight">\(\beta_0^0\)</span> as a function of
the initial data. The next part of the initialization process
proceeds as follows.</p>
<ol class="arabic">
<li><p class="first"><em>Initial Projection</em>: if do_initial_projection = T, then we
first project the velocity field with <span class="math notranslate nohighlight">\(\rho = 1\)</span> and <span class="math notranslate nohighlight">\(\beta_0^0\)</span>.
The initial projection does not see reactions
or external heating, and thus we set <span class="math notranslate nohighlight">\(\dot\omega = \Hnuc = \Hext = 0\)</span> in <span class="math notranslate nohighlight">\(S\)</span>.
The reason for ignoring reactions and heating is that we need some kind of
time scale over which to compute the effect of reactions, but we first
need an estimate of the velocity
field in order to derive the time step that will be used as a time scale.
The elliptic equation we solve is</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \beta_0^0 \nabla \phi = \underbrace{\beta_0^0(S - \Sbar)}_\mathrm{0~ except~ for~ diffusion} - \nabla \cdot (\beta_0^0 \Ub^{\initp})\]</div>
<p>This <span class="math notranslate nohighlight">\(\phi\)</span> is then used to correct the velocity field to obtain <span class="math notranslate nohighlight">\(\Ub^{0,0}\)</span>.
If do_initial_projection = F, set <span class="math notranslate nohighlight">\(\Ub^{0,0} = \Ub^{\initp}\)</span>.</p>
</li>
<li><p class="first"><em>“Divu” iterations</em>: Next we do init_divu_iter iterations
to project the velocity field using a constraint that sees reactions
and external heating.
The initial timestep estimate is provided by firstdt and
<span class="math notranslate nohighlight">\(\Ub^{0,0}\)</span>, to allow us to compute the effect of reactions over <span class="math notranslate nohighlight">\(\Delta t/2\)</span>.</p>
<p><strong>Do</strong> <span class="math notranslate nohighlight">\(\nu = 1,...,N_{\rm iters}^{S}\)</span>.</p>
<ol class="arabic">
<li><p class="first">Estimate <span class="math notranslate nohighlight">\(\Delta t^\nu\)</span> using <span class="math notranslate nohighlight">\(\Ub^{0,\nu-1}\)</span> and <span class="math notranslate nohighlight">\(w_0^{\nu-1}.\)</span></p>
</li>
<li><p class="first"><strong>React State</strong><span class="math notranslate nohighlight">\([ \rho^{\initp},(\rho h)^{\initp}, X_k^{\initp}, T^{\initp},
(\rho^{\initp} \Hext), p_0^{\initp}] \rightarrow [\rho^{\outp}, (\rho h)^{\outp},
X_k^{\outp}, T^{\outp}, (\rho \omegadot_k)^{0,\nu} ].\)</span></p>
</li>
<li><p class="first">Compute <span class="math notranslate nohighlight">\(S^{0,\nu}\)</span> from equation (<a class="reference external" href="#eq:defineS">[eq:defineS]</a>)
using <span class="math notranslate nohighlight">\((\rho \omegadot_k)^{0,\nu}\)</span> and the initial data.</p>
</li>
<li><p class="first">Compute <span class="math notranslate nohighlight">\(\overline{S^{0,\nu}} = {\mathrm{\bf Avg}} (S^{0,\nu}).\)</span></p>
</li>
<li><p class="first">Compute <span class="math notranslate nohighlight">\(w_0^{\nu}\)</span> as in <strong>Step 2B</strong> using <span class="math notranslate nohighlight">\(\overline{S^{0,\nu}}\)</span> and <span class="math notranslate nohighlight">\(\psi=0\)</span>.</p>
</li>
<li><p class="first">Project <span class="math notranslate nohighlight">\(\Ub^{0,\nu-1}\)</span> using <span class="math notranslate nohighlight">\(\beta_0^0\)</span> and
<span class="math notranslate nohighlight">\((S^{0,\nu} - \overline{S^{0,\nu}})\)</span> as the source term.
This yields <span class="math notranslate nohighlight">\(\Ub^{0,\nu}.\)</span> In this projection, again the density is
set to 1, and the elliptic equation we solve is:</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \beta_0^0 \nabla \phi = \beta_0 (S - \Sbar)- \nabla \cdot (\beta_0^0 \Ub^{0,\nu-1})\]</div>
</li>
</ol>
<p><strong>End do.</strong></p>
<p>Define <span class="math notranslate nohighlight">\(S^0 = S^{0,N_{\rm iters}^S}\)</span>, <span class="math notranslate nohighlight">\(w_0^{-\myhalf} = w_0^{N_{\rm iters}^S}\)</span>,
<span class="math notranslate nohighlight">\(\dt^0 = \Delta t^{N_{\rm iters}^S},\)</span> and <span class="math notranslate nohighlight">\(\Ub^0 = \Ub^{0,N_{\rm iters}^S}.\)</span></p>
</li>
</ol>
<p>Next, we need to construct approximations to <span class="math notranslate nohighlight">\(\etarho^{-\myhalf}, \psi^{-\myhalf}, S^1\)</span>,
and <span class="math notranslate nohighlight">\(\pi^{-\myhalf}\)</span>. As initial approximations, set
<span class="math notranslate nohighlight">\(\etarho^{-\myhalf}=0, \psi^{-\myhalf}=0, S^{1,0}=S^0\)</span>, and <span class="math notranslate nohighlight">\(\pi^{-\myhalf}=0.\)</span></p>
<ol class="arabic">
<li><p class="first"><em>Pressure iterations</em>: Here we do init_iter iterations to get an
approximation for the lagged pressure:</p>
<p><strong>Do</strong> <span class="math notranslate nohighlight">\(\nu = 1,...,N_{\rm iters}^{\pi}\)</span>.</p>
<ol class="arabic">
<li><p class="first">Perform <strong>Steps 1-11</strong> as described above, using
<span class="math notranslate nohighlight">\(S^{\myhalf,\star\star} = (S^0 + S^{1,\nu-1})/2\)</span> in <strong>Step 2</strong> as described.
The only other difference in the time advancement is that in <strong>Step 11</strong>
we define <span class="math notranslate nohighlight">\({\bf V} = (\Ubt^{1,\star} - \Ubt^0)\)</span> and solve</p>
<div class="math notranslate nohighlight">
\[L_\beta^\rho \phi = D \left ( \beta_0^{\myhalf} {\bf V} \right) - \beta_0^{\myhalf} \left[ \left(S^{1}-\overline{S^{1}}\right) - \left(S^{0}-\overline{S^{0}}\right) \right] \enskip .\]</div>
<p>(The motivation for this form of the projection in the initial pressure iterations
is discussed in <a href="#id39"><span class="problematic" id="id40">:raw-latex:`\cite{almgren:bell:crutchfield}`</span></a>.)
We discard the new velocity resulting from this, but keep the new
value for <span class="math notranslate nohighlight">\(\pi^{\myhalf} = \pi^{-\myhalf} + (1 / \dt) \; \phi.\)</span>
These steps also yield new scalar data at time <span class="math notranslate nohighlight">\(\dt,\)</span> which
we discard, and new values for <span class="math notranslate nohighlight">\(\etarho^{\myhalf}\)</span> (<strong>Step 8C</strong>),
<span class="math notranslate nohighlight">\(\psi^{\myhalf}\)</span> (<strong>Step 8F</strong>),
<span class="math notranslate nohighlight">\(S^{1,\nu}\)</span> (<strong>Step 10A</strong>), and <span class="math notranslate nohighlight">\(\pi^{\myhalf}\)</span> (<strong>Step 11</strong>), which we keep.</p>
</li>
<li><p class="first">Set <span class="math notranslate nohighlight">\(\pi^{-\myhalf} = \pi^{\myhalf}\)</span>, <span class="math notranslate nohighlight">\(\etarho^{-\myhalf} = \etarho^{\myhalf}\)</span>,
and <span class="math notranslate nohighlight">\(\psi^{-\myhalf} = \psi^{\myhalf}\)</span>.</p>
</li>
</ol>
<p><strong>End do.</strong></p>
<p>Finally, we define <span class="math notranslate nohighlight">\(S^1 = S^{1,N_{\rm iters}^\pi}.\)</span></p>
</li>
</ol>
<p>The tolerances for these elliptic solves are described in §&nbsp;<a class="reference external" href="#sec:mgtol">[sec:mgtol]</a>.</p>
</div>
<div class="section" id="changes-from-earlier-implementations">
<h2>Changes from Earlier Implementations<a class="headerlink" href="#changes-from-earlier-implementations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="changes-between-paper-3-and-paper-4">
<h3>Changes Between Paper 3 and Paper 4<a class="headerlink" href="#changes-between-paper-3-and-paper-4" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>We defined the mapping of data between a 1D radial array and the 3D Cartesian
grid for spherical problems (which we improve upon in the multilevel paper).</li>
<li>We update <span class="math notranslate nohighlight">\(T\)</span> after the call to <strong>React State</strong>.</li>
<li>We have created a burning_cutoff_density, where the burning does
not happen below this density. It is presently set to base_cutoff_density.</li>
<li>Use corner coupling in advection.</li>
<li>We have an option, controlled by use_tfromp, to update temperature
using <span class="math notranslate nohighlight">\(T=T(\rho,X_k,p_0)\)</span> rather than <span class="math notranslate nohighlight">\(T=T(\rho,h,X_k)\)</span>. The former completely
decouples enthalpy from our system. For spherical problems, we use
use_tfromp = TRUE, for planar problems, we use use_tfromp = FALSE.</li>
<li>For spherical problems, we have changed the discretization of
<span class="math notranslate nohighlight">\(\Ubt\cdot\nabla p_0\)</span> in the enthalpy update to
<span class="math notranslate nohighlight">\(\nabla\cdot(\Ubt p_0) - p_0\nabla\cdot\Ubt\)</span>.</li>
<li>In paper III we discretized the enthalpy evolution equation in
terms of <span class="math notranslate nohighlight">\(T\)</span>. Since then we have discovered that
discretizing the enthalpy evolution in perturbational form, <span class="math notranslate nohighlight">\((\rho h)'\)</span>,
leads to better numerical properties. We use enthalpy_pred_type= 1.
This is more like paper II.</li>
<li>We have turned off the evolution of <span class="math notranslate nohighlight">\(h\)</span> above the atmosphere and instead
compute <span class="math notranslate nohighlight">\(h\)</span> with the EOS using do_eos_h_above_cutoff = T.</li>
</ol>
</div>
<div class="section" id="changes-between-paper-4-and-the-multilevel-paper">
<h3>Changes Between Paper 4 and the Multilevel Paper<a class="headerlink" href="#changes-between-paper-4-and-the-multilevel-paper" title="Permalink to this headline">¶</a></h3>
<p>See the multilevel paper for the latest.</p>
</div>
<div class="section" id="changes-between-the-multilevel-paper-and-paper-5-raw-latex-cite-wdconvect">
<h3>Changes Between the Multilevel Paper and Paper 5&nbsp;<a href="#id41"><span class="problematic" id="id42">:raw-latex:`\cite{wdconvect}`</span></a><a class="headerlink" href="#changes-between-the-multilevel-paper-and-paper-5-raw-latex-cite-wdconvect" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Added rotation.</li>
</ol>
</div>
<div class="section" id="changes-between-paper-5-and-the-xrb-paper">
<h3>Changes Between Paper 5 and the XRB Paper<a class="headerlink" href="#changes-between-paper-5-and-the-xrb-paper" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>We have added thermal diffusion, controlled by use_thermal_diffusion,
temp_diffusion_formulation, and thermal_diffusion_type.</li>
<li>We added the volume discrepancy term to the velocity constraint equation,
controlled by the input parameter, dpdt_factor.</li>
<li>For certain problems, we need to set do_eos_h_above_cutoff = F
to prevent large, unphysical velocities from appearing near the edge of the star.</li>
</ol>
</div>
<div class="section" id="changes-since-the-xrb-paper">
<h3>Changes Since the XRB Paper<a class="headerlink" href="#changes-since-the-xrb-paper" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>We switched to the new form of the momentum equation to
Eq.&nbsp;<a class="reference external" href="#eq:flow:newmomentum">[eq:flow:newmomentum]</a> to conserve the low-Mach number form of
energy.</li>
<li>We changed the form of the volume discrepancy term to get better
agreement between the two temperatures.</li>
</ol>
</div>
</div>
<div class="section" id="future-considerations">
<h2>Future Considerations<a class="headerlink" href="#future-considerations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Should we use a predictor-corrector for updating the full-state density?
Specifically, after calling <strong>Correct Base</strong>, should we do a full-state density
advance and <strong>Correct Base</strong> using the more accurate estimate of <span class="math notranslate nohighlight">\(\rho_0^{n+1}\)</span>?</li>
<li>We are still exploring the effects of use_tfromp = F for spherical
problems. We would eventually like to run in this mode, but <span class="math notranslate nohighlight">\(T=T(\rho,X_k,p_0)\)</span>
and <span class="math notranslate nohighlight">\(T=T(\rho,h,X_k)\)</span> drift away from each other more than we would like. Our
attempts at incorporating a dpdt_factor for spherical problems have not
been successful.</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="getting_started.html" class="btn btn-neutral float-right" title="Getting Started" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="introduction.html" class="btn btn-neutral" title="Introduction to MAESTROeX" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, MAESTROeX development tem

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"rhozero": "{\\rho_0}", "pizero": "{\\pi_0}", "pizeroone": "{\\pi_0^{(1)}}", "pizerotwo": "{\\pi_0^{(2)}}", "gammabar": "{\\overline{\\Gamma}_1}", "ptl": "{\\partial}", "eb": "{{\\bf e}}", "fb": "{{\\bf f}}", "ib": "{{\\bf i}}", "Ub": "{{\\bf U}}", "Vb": "{{\\bf V}}", "xb": "{{\\bf x}}", "ut": "{{\\tilde{u}}}", "vt": "{{\\tilde{v}}}", "wt": "{{\\tilde{w}}}", "Ubt": "{\\widetilde{\\Ub}}", "edge": "{{\\rm EDGE}}", "mac": "{{\\rm MAC}}", "trans": "{{\\rm TRANS}}", "nablab": "{\\mathbf{\\nabla}}", "cdotb": "{\\mathbf{\\cdot}}", "half": "{\\frac{1}{2}}", "myhalf": "{\\frac{1}{2}}", "nph": "{{n + \\myhalf}}", "nmh": "{{n - \\myhalf}}", "Hext": "{{H_{\\rm ext}}}", "Hnuc": "{{H_{\\rm nuc}}}", "kth": "{k_{\\rm th}}", "pred": "{{\\rm pred}}", "Sbar": "{\\overline{S}}", "inp": "{\\mathrm{in}}", "initp": "{\\mathrm{init}}", "outp": "{\\mathrm{out}}", "uadv": "{\\widetilde{\\mathbf{U}}^{\\mathrm{ADV}}}", "uadvone": "{\\widetilde{\\mathbf{U}}^{\\mathrm{ADV},\\star}}", "uadvonedag": "{\\Ubt^{\\mathrm{ADV},\\dagger,\\star}}", "uadvtwo": "{\\widetilde{\\mathbf{U}}^{\\mathrm{ADV}}}", "uadvtwodag": "{\\Ubt^{\\mathrm{ADV},\\dagger}}", "uadvsdcstar": "{\\mathbf{U}^{\\mathrm{ADV},\\star}}", "uadvsdcpred": "{\\mathbf{U}^{\\mathrm{ADV},\\mathrm{pred}}}", "uadvsdc": "{\\mathbf{U}^{\\mathrm{ADV}}}", "dt": "{\\Delta t}", "dr": "{\\Delta r}", "etarho": "{\\eta_{\\rho}}", "etarhoec": "{\\etarho^{\\rm ec}}", "etarhocc": "{\\etarho^{\\rm cc}}", "etarhoflux": "{\\etarho^{\\rm flux}}", "divetarho": "{\\nabla\\cdot(\\etarho\\eb_r)}", "ow": "{\\overline{w}_0}", "dw": "{\\delta w_0}", "thalf": "{\\frac{3}{2}}", "rhop": "{{\\rho^{\\prime}}}", "omegadot": "{\\dot{\\omega}}", "er": "{\\mathbf{e}_r}", "ex": "{\\mathbf{e}_x}", "ey": "{\\mathbf{e}_y}", "ez": "{\\mathbf{e}_z}", "Omegab": "{{\\bf \\Omega}}", "rb": "{{\\bf r}}", "boxtype": "{{\\tt box\\/}}", "fab": "{{\\tt fab\\/}}", "multifab": "{{\\tt multifab\\/}}", "boxarray": "{{\\tt boxarray\\/}}", "mlboxarray": "{{\\tt ml\\_boxarray\\/}}", "layout": "{{\\tt layout\\/}}", "mllayout": "{{\\tt ml\\_layout\\/}}", "bctower": "{{\\tt bc\\_tower\\/}}", "bclevel": "{{\\tt bc\\_level\\/}}", "mgtower": "{{\\tt mg\\_tower\\/}}", "bndryreg": "{{\\tt bndry\\_reg\\/}}", "runparam": ["{\\index{Runtime parameters!{\\tt #1}}{\\tt #1}}", 1], "runparamidx": ["{\\index{Runtime parameters!{\\tt #1}}}", 1], "code": ["{\\index{Code reference!{\\tt #1}}{\\tt #1}}", 1], "codeidx": ["{\\index{Code reference!{\\tt #1}}}", 1], "otherindex": ["{\\index{#1!#2}}", 2], "fdamp": "{{f_\\mathrm{damp}}}"}}})</script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>